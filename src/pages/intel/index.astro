---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="Gang Intel Database - DPPD">
    <div class="space-y-8">
        <!-- Header -->
        <div>
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Gang Intel Database</h1>
            <p class="text-white/70">Search organizations by name to view intelligence</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="py-12 text-center">
            <div class="animate-spin w-12 h-12 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-white/70">Checking clearance...</p>
        </div>

        <!-- Pending State -->
        <div id="pendingState" class="hidden py-12">
            <div class="max-w-md mx-auto bg-slate-800/50 rounded-lg border border-slate-700 p-8 text-center">
                <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Access Pending</h2>
                <p class="text-white/70 mb-4">Your access is pending approval from an administrator. Please check back later.</p>
                <button onclick="location.reload()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                    Refresh Status
                </button>
            </div>
        </div>

        <!-- Denied State -->
        <div id="deniedState" class="hidden py-12">
            <div class="max-w-md mx-auto bg-slate-800/50 rounded-lg border border-slate-700 p-8 text-center">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2 text-red-400">Access Denied</h2>
                <p class="text-white/70 mb-4">Your access to the Intel Database has been denied. Please contact an administrator if you believe this is an error.</p>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <div class="flex gap-6 flex-col lg:flex-row">
                <!-- Main Content Area -->
                <div class="flex-1 space-y-8">
                    <!-- Status Messages -->
                    <div id="statusMessage" class="hidden rounded-lg p-4 border">
                    </div>

                    <!-- Search Section -->
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-3">
                            <span class="text-xl">üîç</span>
                            Search Organizations
                        </h2>
                        <p class="text-white/60 mb-4">Enter a gang, cartel, militia, or organization name to search the intel database.</p>

                        <div class="flex gap-4">
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Enter organization name (e.g., Vagos, Ballas, Grove Street)"
                                class="flex-1 px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-white/40 focus:ring-2 focus:ring-primary focus:border-transparent"
                            >
                            <button id="searchBtn" class="px-6 py-3 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="hidden space-y-6">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-white/90" id="resultsHeader">Search Results</h2>
                            <button id="clearResultsBtn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-sm">
                                Clear Results
                            </button>
                        </div>
                        <div id="resultsContainer" class="space-y-6">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- Searching State -->
                    <div id="searchingState" class="hidden">
                        <div class="text-center py-12 text-white/60">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-white/20 border-t-primary mb-4"></div>
                            <p>Searching database...</p>
                        </div>
                    </div>
                </div>

                <!-- User Profile Sidebar -->
                <div class="lg:w-72 shrink-0">
                    <div class="sticky top-4">
                        <div id="userCard" class="bg-slate-800/80 rounded-lg border border-slate-700 overflow-hidden">
                            <!-- Profile Image -->
                            <div class="flex justify-center pt-6 pb-4">
                                <div class="relative">
                                    <img id="userPicture" src="" alt="Profile"
                                        class="w-24 h-24 rounded-full border-4 border-cyan-400/50 object-cover shadow-lg" />
                                </div>
                            </div>
                            <!-- User Info -->
                            <div class="px-4 pb-4 text-center">
                                <p id="userCallsignName" class="text-lg font-bold text-yellow-400 mb-1"></p>
                                <p id="userDiscordId" class="text-sm text-white/50 mb-4">ID: <span id="userIdNumber"></span></p>
                                <div class="border-t border-slate-700 pt-4">
                                    <p class="text-xs text-white/40 uppercase tracking-widest mb-3">Clearance Level</p>
                                    <div id="userClearanceBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-yellow-600/80">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4zm-6 8h12v10H6V11z"/>
                                        </svg>
                                        <span id="userClearanceCode" class="font-bold"></span>
                                    </div>
                                </div>
                            </div>
                            <!-- Actions -->
                            <div class="px-4 pb-4">
                                <button id="logoutBtn" class="w-full px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-colors text-sm">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Info Modal -->
    <div id="addInfoModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-lg my-8">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Add Additional Info</h3>
                    <button id="closeAddInfoModal" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="addInfoGangContext" class="mt-3 flex items-center gap-2">
                    <span id="addInfoGangName" class="font-semibold text-white"></span>
                    <span id="addInfoGangType" class="px-2 py-0.5 rounded text-xs font-medium"></span>
                </div>
            </div>
            <div class="p-6">
                <p class="text-white/70 mb-4">Select what type of information you want to add:</p>
                <div class="grid grid-cols-1 gap-3">
                    <button id="addPostBtn" class="flex items-center gap-3 p-4 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors text-left">
                        <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                            </svg>
                        </div>
                        <div>
                            <div class="font-semibold">Add Intel Post</div>
                            <div class="text-sm text-white/50">Add a new intel report or observation</div>
                        </div>
                    </button>
                    <button id="addPersonBtn" class="flex items-center gap-3 p-4 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors text-left">
                        <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <div>
                            <div class="font-semibold">Add Person</div>
                            <div class="text-sm text-white/50">Add a person of interest</div>
                        </div>
                    </button>
                    <button id="addLocationBtn" class="flex items-center gap-3 p-4 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors text-left">
                        <div class="w-10 h-10 bg-orange-500/20 rounded-full flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <div>
                            <div class="font-semibold">Add Location</div>
                            <div class="text-sm text-white/50">Add a known location</div>
                        </div>
                    </button>
                    <button id="addVehicleBtn" class="flex items-center gap-3 p-4 bg-slate-700/50 hover:bg-slate-700 rounded-lg transition-colors text-left">
                        <div class="w-10 h-10 bg-purple-500/20 rounded-full flex items-center justify-center shrink-0">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                            </svg>
                        </div>
                        <div>
                            <div class="font-semibold">Add Vehicle</div>
                            <div class="text-sm text-white/50">Add a known vehicle</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Post Modal -->
    <div id="postModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-lg my-8">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Add Intel Post</h3>
                    <button id="closePostModal" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="postForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Intel Report *</label>
                    <textarea id="postContent" required rows="4" placeholder="Enter your intel report or observation..."
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelPostBtn" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                        Add Post
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Person Modal -->
    <div id="personModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-lg my-8 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Add Person</h3>
                    <button id="closePersonModal" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="personForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Name *</label>
                    <input type="text" id="personName" required placeholder="Full name or known alias"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Aliases (comma separated)</label>
                    <input type="text" id="personAliases" placeholder="e.g., Big Mike, The Shadow"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Role</label>
                        <input type="text" id="personRole" placeholder="e.g., Leader, Enforcer"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Status</label>
                        <select id="personStatus" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="unknown">Unknown</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="incarcerated">Incarcerated</option>
                            <option value="deceased">Deceased</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Last Known Location</label>
                    <input type="text" id="personLocation" placeholder="Address or area"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Photo URL (optional)</label>
                    <input type="text" id="personPhoto" placeholder="https://..."
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Description</label>
                    <textarea id="personDescription" rows="2" placeholder="Physical description or identifying features"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Notes</label>
                    <textarea id="personNotes" rows="2" placeholder="Additional intelligence"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelPersonBtn" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                        Add Person
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Location Modal -->
    <div id="locationModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-lg my-8 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Add Location</h3>
                    <button id="closeLocationModal" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="locationForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Name *</label>
                    <input type="text" id="locationName" required placeholder="Location name"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Type</label>
                        <select id="locationType" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="other">Other</option>
                            <option value="headquarters">Headquarters</option>
                            <option value="safehouse">Safehouse</option>
                            <option value="meetup">Meetup Point</option>
                            <option value="stash">Stash House</option>
                            <option value="business">Business</option>
                            <option value="residence">Residence</option>
                            <option value="territory">Territory</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Status</label>
                        <select id="locationStatus" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="unknown">Unknown</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="under_surveillance">Under Surveillance</option>
                            <option value="raided">Raided</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Address</label>
                    <input type="text" id="locationAddress" placeholder="Full street address"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Photo URL (optional)</label>
                    <input type="text" id="locationPhoto" placeholder="https://..."
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Description</label>
                    <textarea id="locationDescription" rows="2" placeholder="Location details"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Notes</label>
                    <textarea id="locationNotes" rows="2" placeholder="Additional intelligence"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelLocationBtn" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                        Add Location
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="vehicleModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-lg my-8 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Add Vehicle</h3>
                    <button id="closeVehicleModal" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <form id="vehicleForm" class="p-6 space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Year</label>
                        <input type="text" id="vehicleYear" placeholder="e.g., 2023"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Make</label>
                        <input type="text" id="vehicleMake" placeholder="e.g., Toyota"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Model</label>
                        <input type="text" id="vehicleModel" placeholder="e.g., Camry"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Color</label>
                        <input type="text" id="vehicleColor" placeholder="e.g., Black"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">License Plate</label>
                        <input type="text" id="vehiclePlate" placeholder="e.g., ABC123"
                            class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Type</label>
                        <select id="vehicleType" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="car">Car</option>
                            <option value="truck">Truck</option>
                            <option value="suv">SUV</option>
                            <option value="van">Van</option>
                            <option value="motorcycle">Motorcycle</option>
                            <option value="boat">Boat</option>
                            <option value="aircraft">Aircraft</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-1">Status</label>
                        <select id="vehicleStatus" class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="unknown">Unknown</option>
                            <option value="active">Active</option>
                            <option value="impounded">Impounded</option>
                            <option value="stolen">Stolen</option>
                            <option value="destroyed">Destroyed</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Photo URL (optional)</label>
                    <input type="text" id="vehiclePhoto" placeholder="https://..."
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Notes</label>
                    <textarea id="vehicleNotes" rows="2" placeholder="Additional intelligence"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelVehicleBtn" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                        Add Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Details Pop-out Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-4xl my-8 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-700 sticky top-0 bg-slate-800 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <h3 id="detailsModalTitle" class="text-xl font-bold">Organization Details</h3>
                        <span id="detailsModalCategory" class="px-2 py-0.5 rounded text-xs font-medium"></span>
                    </div>
                    <button id="closeDetailsModal" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="detailsModalContent" class="p-6">
                <!-- Content populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Additional Info Required Modal (Profile Setup) -->
    <div id="profileSetupModal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg border border-slate-700 w-full max-w-md my-8">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-cyan-500/20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Additional Info Required</h3>
                        <p class="text-white/60 text-sm">Complete your profile to continue</p>
                    </div>
                </div>
            </div>
            <form id="profileSetupForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Discord Username *</label>
                    <input type="text" id="profileDiscordUsername" required placeholder="e.g., johndoe"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    <p class="text-xs text-white/40 mt-1">Your Discord username (without the #)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/70 mb-1">Discord ID *</label>
                    <input type="text" id="profileDiscordId" required placeholder="e.g., 123456789012345678"
                        class="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    <p class="text-xs text-white/40 mt-1">Your 17-19 digit Discord ID (Right-click your profile &gt; Copy User ID)</p>
                </div>

                <!-- Officer Info Preview (populated after Discord ID lookup) -->
                <div id="officerInfoPreview" class="hidden bg-slate-700/30 rounded-lg p-4 border border-slate-600">
                    <p class="text-xs text-white/40 uppercase tracking-wide mb-2">Chain of Command Data Found</p>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-white/60">Name:</span>
                            <span id="previewOfficerName" class="text-white font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-white/60">Callsign:</span>
                            <span id="previewCallsign" class="text-cyan-400 font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-white/60">Badge Number:</span>
                            <span id="previewBadgeNumber" class="text-white font-medium">-</span>
                        </div>
                    </div>
                </div>

                <div id="profileSetupError" class="hidden text-red-400 text-sm bg-red-500/10 border border-red-500/30 rounded-lg p-3"></div>

                <div class="pt-4">
                    <button type="submit" id="profileSetupSubmitBtn" class="w-full px-4 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-lg transition-colors font-semibold flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Complete Profile Setup
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        let currentUser = null;
        let currentGang = null;
        let allGangs = {}; // Store all gangs by thread ID for lookup

        // Check session
        async function checkSession() {
            try {
                const response = await fetch('/api/intel/session', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('loadingState').classList.add('hidden');

                if (!data.authenticated) {
                    window.location.href = '/intel/login';
                    return null;
                }

                if (data.user.clearanceLevel === 'pending') {
                    document.getElementById('pendingState').classList.remove('hidden');
                    return null;
                }

                if (data.user.clearanceLevel === 'denied') {
                    document.getElementById('deniedState').classList.remove('hidden');
                    return null;
                }

                document.getElementById('mainContent').classList.remove('hidden');

                // Check if profile is incomplete and show the profile setup modal
                if (!data.user.profileComplete) {
                    showProfileSetupModal();
                }

                return data.user;
            } catch (error) {
                console.error('Session error:', error);
                window.location.href = '/intel/login';
                return null;
            }
        }

        // Show the profile setup modal
        function showProfileSetupModal() {
            document.getElementById('profileSetupModal').classList.remove('hidden');
        }

        // Hide the profile setup modal
        function hideProfileSetupModal() {
            document.getElementById('profileSetupModal').classList.add('hidden');
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `rounded-lg p-4 border ${type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-green-500/20 border-green-500/50 text-green-200'}`;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'Unknown';
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        const statusColors = {
            active: { bg: 'bg-green-500/20', border: 'border-green-500/30', text: 'text-green-400' },
            inactive: { bg: 'bg-gray-500/20', border: 'border-gray-500/30', text: 'text-gray-400' },
            incarcerated: { bg: 'bg-orange-500/20', border: 'border-orange-500/30', text: 'text-orange-400' },
            deceased: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400' },
            unknown: { bg: 'bg-slate-500/20', border: 'border-slate-500/30', text: 'text-slate-400' }
        };

        const categoryColors = {
            gang: 'bg-red-500/20 text-red-300',
            cartel: 'bg-orange-500/20 text-orange-300',
            militia: 'bg-yellow-500/20 text-yellow-300',
            crime_family: 'bg-purple-500/20 text-purple-300',
            motorcycle_club: 'bg-blue-500/20 text-blue-300',
            other: 'bg-gray-500/20 text-gray-300'
        };

        function renderGangCard(gang) {
            const thread = gang.thread;
            const hasImage = thread.image && thread.image.trim() !== '';

            return `
                <div class="bg-white/10 backdrop-blur-sm rounded-lg border border-white/20 overflow-hidden" data-gang-id="${thread.id}">
                    <!-- Gang Header -->
                    <div class="p-6 border-b border-white/10">
                        <div class="flex flex-col md:flex-row gap-6">
                            <!-- Gang Image -->
                            <div class="flex-shrink-0">
                                ${hasImage ? `
                                    <img
                                        src="${thread.image}"
                                        alt="${thread.title}"
                                        class="w-32 h-32 md:w-40 md:h-40 object-cover rounded-lg border-2 border-white/20"
                                        onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-32 h-32 md:w-40 md:h-40 bg-slate-700 rounded-lg border-2 border-white/20 flex items-center justify-center\\'><svg class=\\'w-16 h-16 text-white/30\\' fill=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path d=\\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z\\'/></svg></div>';"
                                    >
                                ` : `
                                    <div class="w-32 h-32 md:w-40 md:h-40 bg-slate-700 rounded-lg border-2 border-white/20 flex items-center justify-center">
                                        <svg class="w-16 h-16 text-white/30" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                        </svg>
                                    </div>
                                `}
                            </div>

                            <!-- Gang Info -->
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-2xl font-bold text-white">${thread.title}</h3>
                                    <div class="flex gap-2">
                                        <button class="view-details-btn px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors font-semibold flex items-center gap-2 text-sm" data-thread-id="${thread.id}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                            View Details
                                        </button>
                                        <button class="add-info-btn px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold flex items-center gap-2 text-sm" data-thread-id="${thread.id}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Add Info
                                        </button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                    <div class="bg-slate-700/30 rounded-lg p-3">
                                        <div class="text-white/50 text-xs uppercase tracking-wide mb-1">Category</div>
                                        <div class="text-white font-semibold capitalize">${thread.category.replace('_', ' ')}</div>
                                    </div>
                                    <div class="bg-slate-700/30 rounded-lg p-3">
                                        <div class="text-white/50 text-xs uppercase tracking-wide mb-1">Known Members</div>
                                        <div class="text-white font-semibold text-xl">${gang.totalMembers}</div>
                                    </div>
                                    <div class="bg-slate-700/30 rounded-lg p-3">
                                        <div class="text-white/50 text-xs uppercase tracking-wide mb-1">Locations</div>
                                        <div class="text-white font-semibold text-xl">${gang.totalLocations}</div>
                                    </div>
                                    <div class="bg-slate-700/30 rounded-lg p-3">
                                        <div class="text-white/50 text-xs uppercase tracking-wide mb-1">Vehicles</div>
                                        <div class="text-white font-semibold text-xl">${gang.vehicles?.length || 0}</div>
                                    </div>
                                    <div class="bg-slate-700/30 rounded-lg p-3">
                                        <div class="text-white/50 text-xs uppercase tracking-wide mb-1">Intel Reports</div>
                                        <div class="text-white font-semibold text-xl">${gang.totalPosts}</div>
                                    </div>
                                </div>

                                <!-- Member Status Summary -->
                                <div class="flex flex-wrap gap-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${statusColors.active.bg} ${statusColors.active.border} ${statusColors.active.text} border">
                                        ${gang.statusCounts.active} Active
                                    </span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${statusColors.incarcerated.bg} ${statusColors.incarcerated.border} ${statusColors.incarcerated.text} border">
                                        ${gang.statusCounts.incarcerated} Incarcerated
                                    </span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${statusColors.deceased.bg} ${statusColors.deceased.border} ${statusColors.deceased.text} border">
                                        ${gang.statusCounts.deceased} Deceased
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="p-6 border-b border-white/10 bg-slate-800/30">
                        <p class="text-white/80">${thread.description}</p>
                    </div>

                    <!-- Known Members Section -->
                    ${gang.people.length > 0 ? `
                        <div class="p-6 border-b border-white/10">
                            <h4 class="text-lg font-bold text-white/90 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                Known Members (${gang.people.length})
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${gang.people.slice(0, 6).map(person => {
                                    const colors = statusColors[person.status] || statusColors.unknown;
                                    return `
                                        <div class="bg-slate-700/30 rounded-lg p-3 flex items-center gap-3">
                                            ${person.photo ? `
                                                <img src="${person.photo}" alt="${person.name}" class="w-10 h-10 rounded-full object-cover">
                                            ` : `
                                                <div class="w-10 h-10 bg-slate-600 rounded-full flex items-center justify-center text-lg font-bold">
                                                    ${person.name.charAt(0).toUpperCase()}
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="font-semibold truncate">${person.name}</div>
                                                ${person.role ? `<div class="text-white/50 text-xs">${person.role}</div>` : ''}
                                            </div>
                                            <span class="px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text}">
                                                ${person.status || 'unknown'}
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${gang.people.length > 6 ? `<p class="text-white/50 text-sm mt-3">+ ${gang.people.length - 6} more members</p>` : ''}
                        </div>
                    ` : ''}

                    <!-- Known Locations Section -->
                    ${gang.locations.length > 0 ? `
                        <div class="p-6 border-b border-white/10">
                            <h4 class="text-lg font-bold text-white/90 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Known Locations (${gang.locations.length})
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                ${gang.locations.map(location => `
                                    <span class="px-3 py-1 bg-orange-500/20 border border-orange-500/30 text-orange-300 rounded-lg text-sm">
                                        ${location.name}${location.type && location.type !== 'other' ? ` (${location.type})` : ''}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Known Vehicles Section -->
                    ${gang.vehicles.length > 0 ? `
                        <div class="p-6 border-b border-white/10">
                            <h4 class="text-lg font-bold text-white/90 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                                </svg>
                                Known Vehicles (${gang.vehicles.length})
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                ${gang.vehicles.map(vehicle => {
                                    const name = [vehicle.year, vehicle.make, vehicle.model].filter(Boolean).join(' ') || 'Unknown Vehicle';
                                    return `
                                        <span class="px-3 py-1 bg-purple-500/20 border border-purple-500/30 text-purple-300 rounded-lg text-sm">
                                            ${name}${vehicle.color ? ` - ${vehicle.color}` : ''}${vehicle.licensePlate ? ` (${vehicle.licensePlate})` : ''}
                                        </span>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Recent Intel Section -->
                    <div class="p-6">
                        <h4 class="text-lg font-bold text-white/90 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Recent Intel
                        </h4>

                        <div class="space-y-3">
                            ${gang.posts.length > 0 ? gang.posts.slice(0, 5).map(post => `
                                <div class="bg-slate-700/30 rounded-lg p-4 border border-white/10">
                                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-semibold text-white">${post.author}</span>
                                            <span class="text-xs px-2 py-0.5 bg-slate-600 rounded text-white/70">${post.authorRole || 'Officer'}</span>
                                        </div>
                                        <span class="text-white/50 text-sm">${formatDateTime(post.createdAt)}</span>
                                    </div>
                                    <p class="text-white/80 whitespace-pre-wrap">${post.content.length > 300 ? post.content.substring(0, 300) + '...' : post.content}</p>
                                </div>
                            `).join('') : `
                                <p class="text-white/50 text-sm">No intel posts yet.</p>
                            `}
                            ${gang.posts.length > 5 ? `<p class="text-white/50 text-sm mt-3">+ ${gang.posts.length - 5} more intel posts</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function searchDatabase(query) {
            const searchingState = document.getElementById('searchingState');
            const searchResults = document.getElementById('searchResults');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsHeader = document.getElementById('resultsHeader');

            // Show loading, hide results
            searchingState.classList.remove('hidden');
            searchResults.classList.add('hidden');

            try {
                const response = await fetch(`/api/intel/gang-database?q=${encodeURIComponent(query)}`, { credentials: 'include' });
                const data = await response.json();

                searchingState.classList.add('hidden');

                if (!data.success) {
                    showStatus(data.error || 'Search failed', 'error');
                    return;
                }

                if (data.gangs.length === 0) {
                    resultsHeader.textContent = 'No Results Found';
                    resultsContainer.innerHTML = `
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-8 border border-white/20 text-center">
                            <svg class="w-16 h-16 text-white/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-white/70 mb-2">No organizations found</h3>
                            <p class="text-white/50">No intel records match your search for "${query}".</p>
                            <p class="text-white/50 mt-2">Try searching with a different name.</p>
                        </div>
                    `;
                    allGangs = {};
                } else {
                    resultsHeader.textContent = `Search Results (${data.totalResults} organization${data.totalResults > 1 ? 's' : ''} found)`;
                    resultsContainer.innerHTML = data.gangs.map(gang => renderGangCard(gang)).join('');

                    // Store all gangs by thread ID for lookup
                    allGangs = {};
                    data.gangs.forEach(gang => {
                        allGangs[gang.thread.id] = gang;
                    });
                }

                searchResults.classList.remove('hidden');
            } catch (error) {
                console.error('Search error:', error);
                searchingState.classList.add('hidden');
                showStatus('Failed to search database. Please try again.', 'error');
            }
        }

        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', () => {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showStatus('Please enter an organization name to search', 'error');
                return;
            }
            searchDatabase(query);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (!query) {
                    showStatus('Please enter an organization name to search', 'error');
                    return;
                }
                searchDatabase(query);
            }
        });

        document.getElementById('clearResultsBtn').addEventListener('click', () => {
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchInput').value = '';
            currentGang = null;
            allGangs = {};
        });

        // Category display names for the modal
        const categoryDisplayNames = {
            gang: 'Gang',
            cartel: 'Cartel',
            militia: 'Militia',
            crime_family: 'Crime Family',
            motorcycle_club: 'Motorcycle Club',
            other: 'Other'
        };

        // Add Info Button - use event delegation for dynamically created buttons
        document.getElementById('resultsContainer').addEventListener('click', (e) => {
            const addInfoBtn = e.target.closest('.add-info-btn');
            if (addInfoBtn) {
                const threadId = addInfoBtn.dataset.threadId;
                currentGang = allGangs[threadId];
                if (currentGang) {
                    // Update modal with gang name and type
                    const gangNameEl = document.getElementById('addInfoGangName');
                    const gangTypeEl = document.getElementById('addInfoGangType');

                    gangNameEl.textContent = currentGang.thread.title;

                    const category = currentGang.thread.category;
                    gangTypeEl.textContent = categoryDisplayNames[category] || 'Organization';
                    gangTypeEl.className = `px-2 py-0.5 rounded text-xs font-medium ${categoryColors[category] || categoryColors.other}`;

                    document.getElementById('addInfoModal').classList.remove('hidden');
                }
            }

            // View Details Button
            const viewDetailsBtn = e.target.closest('.view-details-btn');
            if (viewDetailsBtn) {
                const threadId = viewDetailsBtn.dataset.threadId;
                const gang = allGangs[threadId];
                if (gang) {
                    openDetailsModal(gang);
                }
            }
        });

        // Details Modal Functions
        let currentDetailsGang = null;
        let currentDetailsFilter = 'all';

        function openDetailsModal(gang) {
            currentDetailsGang = gang;
            currentDetailsFilter = 'all';

            const titleEl = document.getElementById('detailsModalTitle');
            const categoryEl = document.getElementById('detailsModalCategory');
            const contentEl = document.getElementById('detailsModalContent');

            titleEl.textContent = gang.thread.title;

            const category = gang.thread.category;
            categoryEl.textContent = categoryDisplayNames[category] || 'Organization';
            categoryEl.className = `px-2 py-0.5 rounded text-xs font-medium ${categoryColors[category] || categoryColors.other}`;

            contentEl.innerHTML = renderDetailsContent(gang, 'all');
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // Expose to global scope for inline onclick handlers in dynamically generated HTML
        window.switchDetailsFilter = function(filter) {
            if (!currentDetailsGang) return;
            currentDetailsFilter = filter;
            const contentEl = document.getElementById('detailsModalContent');
            contentEl.innerHTML = renderDetailsContent(currentDetailsGang, filter);
        };

        function renderDetailsContent(gang, filter = 'all') {
            const vehicleStatusColors = {
                active: { bg: 'bg-green-500/20', border: 'border-green-500/30', text: 'text-green-400' },
                impounded: { bg: 'bg-orange-500/20', border: 'border-orange-500/30', text: 'text-orange-400' },
                stolen: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400' },
                destroyed: { bg: 'bg-gray-500/20', border: 'border-gray-500/30', text: 'text-gray-400' },
                unknown: { bg: 'bg-slate-500/20', border: 'border-slate-500/30', text: 'text-slate-400' }
            };

            const locationStatusColors = {
                active: { bg: 'bg-green-500/20', border: 'border-green-500/30', text: 'text-green-400' },
                inactive: { bg: 'bg-gray-500/20', border: 'border-gray-500/30', text: 'text-gray-400' },
                under_surveillance: { bg: 'bg-yellow-500/20', border: 'border-yellow-500/30', text: 'text-yellow-400' },
                raided: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400' },
                unknown: { bg: 'bg-slate-500/20', border: 'border-slate-500/30', text: 'text-slate-400' }
            };

            const locationTypeLabels = {
                headquarters: 'HQ',
                safehouse: 'Safehouse',
                meetup: 'Meetup',
                stash: 'Stash',
                business: 'Business',
                residence: 'Residence',
                territory: 'Territory',
                other: 'Other'
            };

            let html = '';

            // Category Filter Tabs
            const filterBtnClass = (f) => f === filter
                ? 'px-4 py-2 rounded-lg font-semibold transition-colors bg-primary text-white'
                : 'px-4 py-2 rounded-lg font-semibold transition-colors bg-slate-700/50 hover:bg-slate-600 text-white/70 hover:text-white';

            html += `
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="switchDetailsFilter('all')" class="${filterBtnClass('all')}">
                            All Intel
                        </button>
                        <button onclick="switchDetailsFilter('people')" class="${filterBtnClass('people')}">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                People (${gang.people?.length || 0})
                            </span>
                        </button>
                        <button onclick="switchDetailsFilter('locations')" class="${filterBtnClass('locations')}">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Locations (${gang.locations?.length || 0})
                            </span>
                        </button>
                        <button onclick="switchDetailsFilter('vehicles')" class="${filterBtnClass('vehicles')}">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                                </svg>
                                Vehicles (${gang.vehicles?.length || 0})
                            </span>
                        </button>
                        <button onclick="switchDetailsFilter('intel')" class="${filterBtnClass('intel')}">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Reports (${gang.posts?.length || 0})
                            </span>
                        </button>
                    </div>
                </div>
            `;

            // Show content based on filter
            const showAll = filter === 'all';
            const showPeople = filter === 'all' || filter === 'people';
            const showLocations = filter === 'all' || filter === 'locations';
            const showVehicles = filter === 'all' || filter === 'vehicles';
            const showIntel = filter === 'all' || filter === 'intel';

            // Description Section (only show in 'all' view)
            if (showAll && gang.thread.description) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white/90 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Overview
                        </h4>
                        <div class="bg-slate-700/30 rounded-lg p-4">
                            <p class="text-white/80">${gang.thread.description}</p>
                        </div>
                    </div>
                `;
            }

            // Stats Summary (only show in 'all' view)
            if (showAll) {
                html += `
                    <div class="mb-6">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 text-center cursor-pointer hover:bg-green-500/20 transition-colors" onclick="switchDetailsFilter('people')">
                                <div class="text-2xl font-bold text-green-400">${gang.people?.length || 0}</div>
                                <div class="text-xs text-white/60 uppercase tracking-wide">Members</div>
                            </div>
                            <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4 text-center cursor-pointer hover:bg-orange-500/20 transition-colors" onclick="switchDetailsFilter('locations')">
                                <div class="text-2xl font-bold text-orange-400">${gang.locations?.length || 0}</div>
                                <div class="text-xs text-white/60 uppercase tracking-wide">Locations</div>
                            </div>
                            <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-4 text-center cursor-pointer hover:bg-purple-500/20 transition-colors" onclick="switchDetailsFilter('vehicles')">
                                <div class="text-2xl font-bold text-purple-400">${gang.vehicles?.length || 0}</div>
                                <div class="text-xs text-white/60 uppercase tracking-wide">Vehicles</div>
                            </div>
                            <div class="bg-cyan-500/10 border border-cyan-500/20 rounded-lg p-4 text-center cursor-pointer hover:bg-cyan-500/20 transition-colors" onclick="switchDetailsFilter('intel')">
                                <div class="text-2xl font-bold text-cyan-400">${gang.posts?.length || 0}</div>
                                <div class="text-xs text-white/60 uppercase tracking-wide">Intel Reports</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Known Members Section
            if (showPeople && gang.people && gang.people.length > 0) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white/90 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            Known Members (${gang.people.length})
                        </h4>
                        <div class="space-y-3">
                            ${gang.people.map(person => {
                                const colors = statusColors[person.status] || statusColors.unknown;
                                return `
                                    <div class="bg-slate-700/30 rounded-lg p-4">
                                        <div class="flex items-start gap-4">
                                            ${person.photo ? `
                                                <img src="${person.photo}" alt="${person.name}" class="w-16 h-16 rounded-lg object-cover border-2 border-slate-600">
                                            ` : `
                                                <div class="w-16 h-16 bg-slate-600 rounded-lg flex items-center justify-center text-2xl font-bold text-white/50">
                                                    ${person.name.charAt(0).toUpperCase()}
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="flex flex-wrap items-center gap-2 mb-1">
                                                    <span class="font-bold text-white text-lg">${person.name}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text} border ${colors.border}">
                                                        ${person.status || 'unknown'}
                                                    </span>
                                                </div>
                                                ${person.role ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Role:</span> ${person.role}</div>` : ''}
                                                ${person.aliases && person.aliases.length > 0 ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Aliases:</span> ${person.aliases.join(', ')}</div>` : ''}
                                                ${person.lastKnownLocation ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Last Known Location:</span> ${person.lastKnownLocation}</div>` : ''}
                                                ${person.description ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Description:</span> ${person.description}</div>` : ''}
                                                ${person.notes ? `<div class="text-sm text-white/60 mt-2 italic">${person.notes}</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Known Locations Section
            if (showLocations && gang.locations && gang.locations.length > 0) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white/90 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Known Locations (${gang.locations.length})
                        </h4>
                        <div class="space-y-3">
                            ${gang.locations.map(location => {
                                const colors = locationStatusColors[location.status] || locationStatusColors.unknown;
                                const typeLabel = locationTypeLabels[location.type] || location.type || 'Other';
                                return `
                                    <div class="bg-slate-700/30 rounded-lg p-4">
                                        <div class="flex items-start gap-4">
                                            ${location.photo ? `
                                                <img src="${location.photo}" alt="${location.name}" class="w-20 h-20 rounded-lg object-cover border-2 border-slate-600">
                                            ` : `
                                                <div class="w-20 h-20 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                                    <svg class="w-10 h-10 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    </svg>
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="flex flex-wrap items-center gap-2 mb-1">
                                                    <span class="font-bold text-white text-lg">${location.name}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-orange-500/20 text-orange-300">${typeLabel}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text} border ${colors.border}">
                                                        ${(location.status || 'unknown').replace('_', ' ')}
                                                    </span>
                                                </div>
                                                ${location.address ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Address:</span> ${location.address}</div>` : ''}
                                                ${location.description ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Description:</span> ${location.description}</div>` : ''}
                                                ${location.notes ? `<div class="text-sm text-white/60 mt-2 italic">${location.notes}</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Known Vehicles Section
            if (showVehicles && gang.vehicles && gang.vehicles.length > 0) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white/90 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                            </svg>
                            Known Vehicles (${gang.vehicles.length})
                        </h4>
                        <div class="space-y-3">
                            ${gang.vehicles.map(vehicle => {
                                const colors = vehicleStatusColors[vehicle.status] || vehicleStatusColors.unknown;
                                const vehicleName = [vehicle.year, vehicle.make, vehicle.model].filter(Boolean).join(' ') || 'Unknown Vehicle';
                                const vehicleTypeLabels = {
                                    car: 'Car', truck: 'Truck', suv: 'SUV', van: 'Van',
                                    motorcycle: 'Motorcycle', boat: 'Boat', aircraft: 'Aircraft', other: 'Other'
                                };
                                const typeLabel = vehicleTypeLabels[vehicle.type] || vehicle.type || 'Vehicle';
                                return `
                                    <div class="bg-slate-700/30 rounded-lg p-4">
                                        <div class="flex items-start gap-4">
                                            ${vehicle.photo ? `
                                                <img src="${vehicle.photo}" alt="${vehicleName}" class="w-24 h-20 rounded-lg object-cover border-2 border-slate-600">
                                            ` : `
                                                <div class="w-24 h-20 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                                    <svg class="w-10 h-10 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                                                    </svg>
                                                </div>
                                            `}
                                            <div class="flex-1 min-w-0">
                                                <div class="flex flex-wrap items-center gap-2 mb-1">
                                                    <span class="font-bold text-white text-lg">${vehicleName}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-purple-500/20 text-purple-300">${typeLabel}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text} border ${colors.border}">
                                                        ${vehicle.status || 'unknown'}
                                                    </span>
                                                </div>
                                                ${vehicle.color ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">Color:</span> ${vehicle.color}</div>` : ''}
                                                ${vehicle.licensePlate ? `<div class="text-sm text-white/70 mb-1"><span class="text-white/50">License Plate:</span> <span class="font-mono bg-slate-600 px-2 py-0.5 rounded">${vehicle.licensePlate}</span></div>` : ''}
                                                ${vehicle.notes ? `<div class="text-sm text-white/60 mt-2 italic">${vehicle.notes}</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Intel Reports Section
            if (showIntel && gang.posts && gang.posts.length > 0) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-white/90 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Intel Reports (${gang.posts.length})
                        </h4>
                        <div class="space-y-3">
                            ${gang.posts.map(post => `
                                <div class="bg-slate-700/30 rounded-lg p-4 border border-white/10">
                                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-semibold text-white">${post.author}</span>
                                            <span class="text-xs px-2 py-0.5 bg-slate-600 rounded text-white/70">${post.authorRole || 'Officer'}</span>
                                        </div>
                                        <span class="text-white/50 text-sm">${formatDateTime(post.createdAt)}</span>
                                    </div>
                                    <p class="text-white/80 whitespace-pre-wrap">${post.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Empty State - Context aware based on filter
            const hasNoData = !gang.people?.length && !gang.locations?.length && !gang.vehicles?.length && !gang.posts?.length;
            const filterEmptyStates = {
                people: { condition: !gang.people?.length, text: 'No known members recorded.', subtext: 'Add people of interest to build this profile.' },
                locations: { condition: !gang.locations?.length, text: 'No known locations recorded.', subtext: 'Add locations to track their territory.' },
                vehicles: { condition: !gang.vehicles?.length, text: 'No known vehicles recorded.', subtext: 'Add vehicles associated with this organization.' },
                intel: { condition: !gang.posts?.length, text: 'No intel reports filed.', subtext: 'Add intel posts to document observations.' }
            };

            if (filter === 'all' && hasNoData) {
                html += `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 text-white/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <p class="text-white/50">No detailed intel gathered yet.</p>
                        <p class="text-white/40 text-sm mt-1">Use "Add Info" to contribute intelligence.</p>
                    </div>
                `;
            } else if (filter !== 'all' && filterEmptyStates[filter]?.condition) {
                const emptyState = filterEmptyStates[filter];
                html += `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 text-white/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <p class="text-white/50">${emptyState.text}</p>
                        <p class="text-white/40 text-sm mt-1">${emptyState.subtext}</p>
                    </div>
                `;
            }

            return html;
        }

        // Close Details Modal
        document.getElementById('closeDetailsModal').addEventListener('click', () => {
            document.getElementById('detailsModal').classList.add('hidden');
        });

        document.getElementById('closeAddInfoModal').addEventListener('click', () => {
            document.getElementById('addInfoModal').classList.add('hidden');
        });

        // Add Post
        document.getElementById('addPostBtn').addEventListener('click', () => {
            document.getElementById('addInfoModal').classList.add('hidden');
            document.getElementById('postModal').classList.remove('hidden');
        });

        document.getElementById('closePostModal').addEventListener('click', () => {
            document.getElementById('postModal').classList.add('hidden');
        });

        document.getElementById('cancelPostBtn').addEventListener('click', () => {
            document.getElementById('postModal').classList.add('hidden');
        });

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentGang) return;

            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                showStatus('Please enter content for the post', 'error');
                return;
            }

            try {
                const response = await fetch('/api/intel/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: currentGang.thread.id, content }),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('postModal').classList.add('hidden');
                document.getElementById('postContent').value = '';
                showStatus('Intel post added successfully');

                // Refresh search results
                const query = document.getElementById('searchInput').value.trim();
                if (query) searchDatabase(query);
            } catch (error) {
                showStatus('Error adding post: ' + error.message, 'error');
            }
        });

        // Add Person
        document.getElementById('addPersonBtn').addEventListener('click', () => {
            document.getElementById('addInfoModal').classList.add('hidden');
            document.getElementById('personModal').classList.remove('hidden');
        });

        document.getElementById('closePersonModal').addEventListener('click', () => {
            document.getElementById('personModal').classList.add('hidden');
        });

        document.getElementById('cancelPersonBtn').addEventListener('click', () => {
            document.getElementById('personModal').classList.add('hidden');
        });

        document.getElementById('personForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentGang) return;

            const aliasesStr = document.getElementById('personAliases').value;
            const aliases = aliasesStr ? aliasesStr.split(',').map(a => a.trim()).filter(a => a) : [];

            const payload = {
                threadId: currentGang.thread.id,
                name: document.getElementById('personName').value,
                aliases,
                role: document.getElementById('personRole').value,
                status: document.getElementById('personStatus').value,
                lastKnownLocation: document.getElementById('personLocation').value,
                photo: document.getElementById('personPhoto').value,
                description: document.getElementById('personDescription').value,
                notes: document.getElementById('personNotes').value,
            };

            try {
                const response = await fetch('/api/intel/people', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('personModal').classList.add('hidden');
                document.getElementById('personForm').reset();
                showStatus('Person added successfully');

                // Refresh search results
                const query = document.getElementById('searchInput').value.trim();
                if (query) searchDatabase(query);
            } catch (error) {
                showStatus('Error adding person: ' + error.message, 'error');
            }
        });

        // Add Location
        document.getElementById('addLocationBtn').addEventListener('click', () => {
            document.getElementById('addInfoModal').classList.add('hidden');
            document.getElementById('locationModal').classList.remove('hidden');
        });

        document.getElementById('closeLocationModal').addEventListener('click', () => {
            document.getElementById('locationModal').classList.add('hidden');
        });

        document.getElementById('cancelLocationBtn').addEventListener('click', () => {
            document.getElementById('locationModal').classList.add('hidden');
        });

        document.getElementById('locationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentGang) return;

            const payload = {
                threadId: currentGang.thread.id,
                name: document.getElementById('locationName').value,
                type: document.getElementById('locationType').value,
                status: document.getElementById('locationStatus').value,
                address: document.getElementById('locationAddress').value,
                photo: document.getElementById('locationPhoto').value,
                description: document.getElementById('locationDescription').value,
                notes: document.getElementById('locationNotes').value,
            };

            try {
                const response = await fetch('/api/intel/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('locationModal').classList.add('hidden');
                document.getElementById('locationForm').reset();
                showStatus('Location added successfully');

                // Refresh search results
                const query = document.getElementById('searchInput').value.trim();
                if (query) searchDatabase(query);
            } catch (error) {
                showStatus('Error adding location: ' + error.message, 'error');
            }
        });

        // Add Vehicle
        document.getElementById('addVehicleBtn').addEventListener('click', () => {
            document.getElementById('addInfoModal').classList.add('hidden');
            document.getElementById('vehicleModal').classList.remove('hidden');
        });

        document.getElementById('closeVehicleModal').addEventListener('click', () => {
            document.getElementById('vehicleModal').classList.add('hidden');
        });

        document.getElementById('cancelVehicleBtn').addEventListener('click', () => {
            document.getElementById('vehicleModal').classList.add('hidden');
        });

        document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentGang) return;

            const payload = {
                threadId: currentGang.thread.id,
                make: document.getElementById('vehicleMake').value,
                model: document.getElementById('vehicleModel').value,
                year: document.getElementById('vehicleYear').value,
                color: document.getElementById('vehicleColor').value,
                licensePlate: document.getElementById('vehiclePlate').value,
                type: document.getElementById('vehicleType').value,
                status: document.getElementById('vehicleStatus').value,
                photo: document.getElementById('vehiclePhoto').value,
                notes: document.getElementById('vehicleNotes').value,
            };

            try {
                const response = await fetch('/api/intel/vehicles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('vehicleModal').classList.add('hidden');
                document.getElementById('vehicleForm').reset();
                showStatus('Vehicle added successfully');

                // Refresh search results
                const query = document.getElementById('searchInput').value.trim();
                if (query) searchDatabase(query);
            } catch (error) {
                showStatus('Error adding vehicle: ' + error.message, 'error');
            }
        });

        // Clearance level styling
        const clearanceStyles = {
            'pending': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', code: 'P' },
            'public_trust': { bg: 'bg-blue-500/20', text: 'text-blue-400', code: 'PT' },
            'confidential': { bg: 'bg-green-500/20', text: 'text-green-400', code: 'C' },
            'secret': { bg: 'bg-purple-500/20', text: 'text-purple-400', code: 'S' },
            'top_secret': { bg: 'bg-red-500/20', text: 'text-red-400', code: 'TS' },
            'top_secret_sci': { bg: 'bg-red-600/20', text: 'text-red-300', code: 'TS/SCI' },
            'special_access': { bg: 'bg-pink-500/20', text: 'text-pink-400', code: 'SA' },
            'denied': { bg: 'bg-gray-500/20', text: 'text-gray-400', code: 'X' }
        };

        async function updateUserSidebar(user) {
            // Update profile picture
            const userPicture = document.getElementById('userPicture');
            if (user.picture) {
                userPicture.src = user.picture;
            } else {
                userPicture.src = 'https://via.placeholder.com/96';
            }

            // Update name display - fetch from chain of command using Discord ID
            const userCallsignName = document.getElementById('userCallsignName');

            // Default values from session
            let displayCallsign = user.callsign || '';
            let displayName = user.officerName || user.name || 'Officer';

            // If user has a Discord ID, fetch the latest info from chain of command
            if (user.discordId) {
                try {
                    const profileResponse = await fetch(`/api/intel/profile?discordId=${user.discordId}`, { credentials: 'include' });
                    const profileData = await profileResponse.json();

                    if (profileData.success && profileData.found && profileData.officerInfo) {
                        // Use chain of command data
                        displayCallsign = profileData.officerInfo.callsign || displayCallsign;
                        displayName = profileData.officerInfo.officerName || displayName;
                    }
                } catch (error) {
                    console.error('Error fetching officer info from chain of command:', error);
                    // Fall back to session data
                }
            }

            // Display as "CALLSIGN | NAME"
            if (displayCallsign && displayName) {
                userCallsignName.textContent = `${displayCallsign} | ${displayName}`;
            } else if (displayCallsign) {
                userCallsignName.textContent = displayCallsign;
            } else {
                userCallsignName.textContent = displayName;
            }

            // Update ID number display (use Discord ID if available)
            const userIdNumber = document.getElementById('userIdNumber');
            if (user.discordId) {
                userIdNumber.textContent = user.discordId;
            } else if (user.id) {
                userIdNumber.textContent = user.id;
            } else {
                userIdNumber.textContent = 'N/A';
            }

            // Update clearance badge with appropriate styling based on clearance level
            const clearanceLevel = user.clearanceLevel || 'pending';
            const style = clearanceStyles[clearanceLevel] || clearanceStyles.pending;
            const userClearanceBadge = document.getElementById('userClearanceBadge');
            userClearanceBadge.className = `inline-flex items-center gap-2 px-4 py-2 rounded-lg ${style.bg} ${style.text}`;

            const userClearanceCode = document.getElementById('userClearanceCode');
            userClearanceCode.textContent = style.code;
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/intel/logout', { method: 'POST', credentials: 'include' });
                window.location.href = '/intel/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/intel/login';
            }
        });

        // Profile Setup Form - Discord ID lookup on blur
        let lookupTimeout = null;
        document.getElementById('profileDiscordId').addEventListener('input', function() {
            const discordId = this.value.trim();
            const previewSection = document.getElementById('officerInfoPreview');

            // Clear previous timeout
            if (lookupTimeout) clearTimeout(lookupTimeout);

            // Hide preview if ID is too short
            if (!/^\d{17,19}$/.test(discordId)) {
                previewSection.classList.add('hidden');
                return;
            }

            // Debounce the lookup
            lookupTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/intel/profile?discordId=${discordId}`, { credentials: 'include' });
                    const data = await response.json();

                    if (data.success && data.found && data.officerInfo) {
                        document.getElementById('previewOfficerName').textContent = data.officerInfo.officerName || '-';
                        document.getElementById('previewCallsign').textContent = data.officerInfo.callsign || '-';
                        document.getElementById('previewBadgeNumber').textContent = data.officerInfo.badgeNumber || '-';
                        previewSection.classList.remove('hidden');
                    } else {
                        previewSection.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error looking up officer info:', error);
                    previewSection.classList.add('hidden');
                }
            }, 500);
        });

        // Profile Setup Form Submission
        document.getElementById('profileSetupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('profileSetupSubmitBtn');
            const errorEl = document.getElementById('profileSetupError');
            const discordUsername = document.getElementById('profileDiscordUsername').value.trim();
            const discordId = document.getElementById('profileDiscordId').value.trim();

            // Clear previous errors
            errorEl.classList.add('hidden');
            errorEl.textContent = '';

            // Validate Discord ID format
            if (!/^\d{17,19}$/.test(discordId)) {
                errorEl.textContent = 'Invalid Discord ID format. It should be a 17-19 digit number. To find your Discord ID, enable Developer Mode in Discord settings, then right-click your profile and select "Copy User ID".';
                errorEl.classList.remove('hidden');
                return;
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
            `;

            try {
                const response = await fetch('/api/intel/profile', {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ discordUsername, discordId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update profile');
                }

                // Success - update currentUser and sidebar, then hide modal
                if (data.user) {
                    currentUser = { ...currentUser, ...data.user };
                    await updateUserSidebar(currentUser);
                }

                hideProfileSetupModal();
                showStatus('Profile setup complete! Your information has been saved.', 'success');

            } catch (error) {
                console.error('Profile update error:', error);
                errorEl.textContent = error.message || 'Failed to update profile. Please try again.';
                errorEl.classList.remove('hidden');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Complete Profile Setup
                `;
            }
        });

        // Initialize
        checkSession().then(async user => {
            if (user) {
                currentUser = user;
                await updateUserSidebar(user);
            }
        });
    </script>
</Layout>
