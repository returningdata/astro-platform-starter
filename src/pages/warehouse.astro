---
import Layout from '../layouts/Layout.astro';
---

<Layout title="DPPD Warehouse - Del Perro Police Department" description="View department vehicles and equipment inventory">
    <div class="space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">DPPD Warehouse</h1>
                <p class="text-white/70">View department vehicles and equipment</p>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="relative flex-grow">
                <input type="text" id="searchInput" placeholder="Search vehicles..." class="w-full px-4 py-3 pl-12 bg-slate-800/50 border border-white/10 rounded-xl text-white placeholder-white/40 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>

        <!-- Vehicle Grid -->
        <div id="warehouseGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Loading state -->
            <div class="col-span-full text-center py-12 text-white/60">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                <p>Loading warehouse vehicles...</p>
            </div>
        </div>
    </div>

    <!-- Vehicle Detail Modal -->
    <div id="vehicleModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div class="relative w-full max-w-4xl mx-auto my-8">
            <!-- Close Button -->
            <button id="closeVehicleModal" class="absolute -top-12 right-0 text-white/80 hover:text-white p-2 transition-colors z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Modal Content -->
            <div class="bg-slate-800 rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
                <!-- Image Gallery -->
                <div id="modalImageContainer" class="relative aspect-video bg-slate-900">
                    <img id="modalVehicleImage" src="" alt="" class="w-full h-full object-cover">
                    <!-- Image Navigation (if multiple images) -->
                    <button id="modalImagePrev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white p-3 bg-black/50 hover:bg-black/70 rounded-full transition-all hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button id="modalImageNext" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white p-3 bg-black/50 hover:bg-black/70 rounded-full transition-all hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                    <div id="modalImageCounter" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/70 text-white px-3 py-1 rounded-full text-sm hidden"></div>
                </div>

                <!-- Vehicle Info -->
                <div class="p-6 space-y-5">
                    <!-- Title -->
                    <h2 id="modalVehicleName" class="text-2xl md:text-3xl font-bold text-white"></h2>

                    <!-- Flags -->
                    <div id="modalVehicleFlags" class="flex flex-wrap gap-2"></div>

                    <!-- Spawn Codes -->
                    <div id="modalSpawnCodes" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>

                    <!-- Description -->
                    <div id="modalDescriptionContainer" class="pt-4 border-t border-white/10">
                        <h3 class="text-sm font-semibold text-white/60 uppercase tracking-wider mb-2">Description</h3>
                        <p id="modalVehicleDescription" class="text-white/80 leading-relaxed"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const flagColors = {
            blue: 'bg-blue-500/20 text-blue-300 border-blue-500/30',
            red: 'bg-red-500/20 text-red-300 border-red-500/30',
            green: 'bg-green-500/20 text-green-300 border-green-500/30',
            yellow: 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30',
            purple: 'bg-purple-500/20 text-purple-300 border-purple-500/30',
            orange: 'bg-orange-500/20 text-orange-300 border-orange-500/30',
            pink: 'bg-pink-500/20 text-pink-300 border-pink-500/30',
            cyan: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30',
            indigo: 'bg-indigo-500/20 text-indigo-300 border-indigo-500/30',
            teal: 'bg-teal-500/20 text-teal-300 border-teal-500/30'
        };

        // Vehicle groups in display order (loaded from API)
        const DEFAULT_VEHICLE_GROUPS = ['Training', 'Patrol', 'Heat', 'Air-1/Air-Tac', 'Transport', 'Supervisor/Command', 'S.W.A.T.', 'Other'];
        let VEHICLE_GROUPS = [...DEFAULT_VEHICLE_GROUPS];

        let warehouseData = [];
        let filteredData = [];
        let currentVehicle = null;
        let currentImageIndex = 0;

        async function loadWarehouse() {
            try {
                const response = await fetch('/api/warehouse');
                const data = await response.json();
                warehouseData = data.warehouse || [];
                VEHICLE_GROUPS = data.groupOrder || [...DEFAULT_VEHICLE_GROUPS];
                filteredData = [...warehouseData];
                renderWarehouse();
                setupModal();
                setupSearch();
            } catch (error) {
                console.error('Failed to load warehouse:', error);
                document.getElementById('warehouseGrid').innerHTML = `
                    <div class="col-span-full text-center py-12 text-red-400">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <p>Failed to load warehouse inventory. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query === '') {
                    filteredData = [...warehouseData];
                } else {
                    filteredData = warehouseData.filter(vehicle =>
                        vehicle.name.toLowerCase().includes(query) ||
                        (vehicle.description && vehicle.description.toLowerCase().includes(query)) ||
                        (vehicle.spawnCode && vehicle.spawnCode.toLowerCase().includes(query)) ||
                        (vehicle.spawnByModel && vehicle.spawnByModel.toLowerCase().includes(query)) ||
                        (vehicle.flags && vehicle.flags.some(f => f.name.toLowerCase().includes(query)))
                    );
                }
                renderWarehouse();
            });
        }

        function renderWarehouse() {
            const grid = document.getElementById('warehouseGrid');

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-white/60">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p class="text-lg">No vehicles found</p>
                        <p class="text-sm text-white/40 mt-1">Try adjusting your search</p>
                    </div>
                `;
                return;
            }

            // Group vehicles by their group property
            const groupedVehicles = {};
            VEHICLE_GROUPS.forEach(group => {
                groupedVehicles[group] = [];
            });
            // Also ensure 'Ungrouped' exists for vehicles without a group
            groupedVehicles['Ungrouped'] = [];

            filteredData.forEach((vehicle, index) => {
                const group = vehicle.group || 'Ungrouped';
                if (!groupedVehicles[group]) {
                    // Vehicle has a group that's not in VEHICLE_GROUPS (custom group)
                    groupedVehicles[group] = [];
                }
                groupedVehicles[group].push({ vehicle, originalIndex: index });
            });

            // Build HTML with group sections
            // First show groups in VEHICLE_GROUPS order, then any extra groups, then Ungrouped
            let html = '';
            const displayOrder = [...VEHICLE_GROUPS];

            // Add any extra groups that exist in data but not in VEHICLE_GROUPS
            Object.keys(groupedVehicles).forEach(group => {
                if (!displayOrder.includes(group) && group !== 'Ungrouped') {
                    displayOrder.push(group);
                }
            });

            // Add Ungrouped at the end if it has vehicles
            if (groupedVehicles['Ungrouped'] && groupedVehicles['Ungrouped'].length > 0) {
                displayOrder.push('Ungrouped');
            }

            displayOrder.forEach(group => {
                const vehicles = groupedVehicles[group];
                if (vehicles.length === 0) return;

                html += `
                    <div class="col-span-full mt-6 first:mt-0">
                        <h2 class="text-2xl font-bold text-white mb-4 pb-2 border-b border-white/10">${group}</h2>
                    </div>
                `;

                vehicles.forEach(({ vehicle, originalIndex }) => {
                    const images = vehicle.imageUrls || [];
                    const hasImages = images.length > 0;
                    const flags = vehicle.flags || [];
                    const hasFlags = flags.length > 0;
                    // Only check the flags array for Bulletproof (not items array to avoid false positives)
                    const hasBulletproof = flags.some(f => f.name.toLowerCase().includes('bulletproof'));
                    const otherFlagsCount = hasFlags ? flags.filter(f => !f.name.toLowerCase().includes('bulletproof')).length : 0;

                    html += `
                    <div class="vehicle-card cursor-pointer group bg-slate-800/40 rounded-2xl overflow-hidden border border-white/5 hover:border-primary/30 transition-all duration-300 hover:shadow-xl hover:shadow-primary/10 hover:-translate-y-1" data-vehicle-index="${originalIndex}">
                        <!-- Vehicle Image -->
                        <div class="relative aspect-[16/10] bg-slate-900/50 overflow-hidden">
                            ${hasImages ? `
                                <img
                                    src="${images[0]}"
                                    alt="${vehicle.name}"
                                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                    onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full text-white/20\\'><svg class=\\'w-16 h-16\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1\\' d=\\'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\\'/></svg></div>'"
                                >
                            ` : `
                                <div class="flex items-center justify-center h-full text-white/20">
                                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                            `}

                            <!-- Flag Indicator (top right) -->
                            ${hasBulletproof ? `
                                <div class="absolute top-3 right-3 flex items-center gap-2">
                                    <div class="bg-red-600/90 backdrop-blur-sm text-white text-xs px-2.5 py-1.5 rounded-full flex items-center gap-1.5 font-bold shadow-lg shadow-red-500/30 border border-red-400/50">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm-1 6h2v4h-2V8zm0 6h2v2h-2v-2z"/>
                                        </svg>
                                        <span>Bulletproof</span>
                                    </div>
                                    ${otherFlagsCount > 0 ? `
                                        <div class="bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full flex items-center gap-1.5 font-medium">
                                            <svg class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M4 24V1h16l-4 7 4 7H6v9H4z"/>
                                            </svg>
                                            <span>+${otherFlagsCount}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : hasFlags ? `
                                <div class="absolute top-3 right-3 flex items-center gap-1">
                                    <div class="bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full flex items-center gap-1.5 font-medium">
                                        <svg class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M4 24V1h16l-4 7 4 7H6v9H4z"/>
                                        </svg>
                                        <span>${flags.length}</span>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Hover Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-60"></div>
                        </div>

                        <!-- Vehicle Name -->
                        <div class="p-4 bg-gradient-to-b from-slate-800/80 to-slate-800/40">
                            <h3 class="text-lg font-bold text-white text-center line-clamp-2">${vehicle.name}</h3>
                        </div>
                    </div>
                `;
                });
            });

            grid.innerHTML = html;

            // Attach click listeners for vehicle cards
            document.querySelectorAll('.vehicle-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const vehicleIndex = parseInt(card.dataset.vehicleIndex);
                    const vehicle = filteredData[vehicleIndex];
                    if (vehicle) {
                        openVehicleModal(vehicle);
                    }
                });
            });
        }

        function setupModal() {
            const modal = document.getElementById('vehicleModal');
            const closeBtn = document.getElementById('closeVehicleModal');
            const prevBtn = document.getElementById('modalImagePrev');
            const nextBtn = document.getElementById('modalImageNext');

            closeBtn.addEventListener('click', closeVehicleModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeVehicleModal();
            });

            prevBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigateImage(-1);
            });
            nextBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigateImage(1);
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (!modal.classList.contains('hidden')) {
                    if (e.key === 'Escape') closeVehicleModal();
                    if (e.key === 'ArrowLeft') navigateImage(-1);
                    if (e.key === 'ArrowRight') navigateImage(1);
                }
            });
        }

        function openVehicleModal(vehicle) {
            currentVehicle = vehicle;
            currentImageIndex = 0;

            const modal = document.getElementById('vehicleModal');
            const images = vehicle.imageUrls || [];
            const flags = vehicle.flags || [];

            // Set vehicle name
            document.getElementById('modalVehicleName').textContent = vehicle.name;

            // Set image
            const imgEl = document.getElementById('modalVehicleImage');
            if (images.length > 0) {
                imgEl.src = images[0];
                imgEl.alt = vehicle.name;
                document.getElementById('modalImageContainer').classList.remove('hidden');
            } else {
                imgEl.src = '';
                document.getElementById('modalImageContainer').innerHTML = `
                    <div class="flex items-center justify-center h-full bg-slate-900 text-white/20">
                        <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                `;
            }

            // Show/hide image navigation
            const prevBtn = document.getElementById('modalImagePrev');
            const nextBtn = document.getElementById('modalImageNext');
            const counter = document.getElementById('modalImageCounter');

            if (images.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                counter.classList.remove('hidden');
                counter.textContent = `1 / ${images.length}`;
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                counter.classList.add('hidden');
            }

            // Set flags
            const flagsContainer = document.getElementById('modalVehicleFlags');
            if (flags.length > 0) {
                flagsContainer.innerHTML = flags.map(flag => `
                    <span class="px-3 py-1.5 text-sm font-medium rounded-full border ${flagColors[flag.color] || flagColors.blue}">
                        ${flag.name}
                    </span>
                `).join('');
                flagsContainer.classList.remove('hidden');
            } else {
                flagsContainer.innerHTML = '';
                flagsContainer.classList.add('hidden');
            }

            // Set spawn codes
            const spawnCodesContainer = document.getElementById('modalSpawnCodes');
            let spawnCodesHtml = '';
            if (vehicle.spawnCode) {
                spawnCodesHtml += `
                    <div class="bg-slate-700/50 p-4 rounded-xl">
                        <span class="text-white/60 text-sm font-medium block mb-1">Spawn Code</span>
                        <code class="text-primary font-mono text-lg font-bold">${vehicle.spawnCode}</code>
                    </div>
                `;
            }
            if (vehicle.spawnByModel) {
                spawnCodesHtml += `
                    <div class="bg-slate-700/50 p-4 rounded-xl">
                        <span class="text-white/60 text-sm font-medium block mb-1">Model Code</span>
                        <code class="text-emerald-400 font-mono text-lg font-bold">${vehicle.spawnByModel}</code>
                    </div>
                `;
            }
            spawnCodesContainer.innerHTML = spawnCodesHtml;
            if (!spawnCodesHtml) {
                spawnCodesContainer.classList.add('hidden');
            } else {
                spawnCodesContainer.classList.remove('hidden');
            }

            // Set description
            const descContainer = document.getElementById('modalDescriptionContainer');
            const descEl = document.getElementById('modalVehicleDescription');
            if (vehicle.description) {
                descEl.textContent = vehicle.description;
                descContainer.classList.remove('hidden');
            } else {
                descContainer.classList.add('hidden');
            }

            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeVehicleModal() {
            const modal = document.getElementById('vehicleModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            currentVehicle = null;
        }

        function navigateImage(direction) {
            if (!currentVehicle || !currentVehicle.imageUrls || currentVehicle.imageUrls.length <= 1) return;

            const images = currentVehicle.imageUrls;
            currentImageIndex = (currentImageIndex + direction + images.length) % images.length;

            document.getElementById('modalVehicleImage').src = images[currentImageIndex];
            document.getElementById('modalImageCounter').textContent = `${currentImageIndex + 1} / ${images.length}`;
        }

        loadWarehouse();
    </script>
</Layout>
