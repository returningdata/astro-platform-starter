---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin - Warehouse Management" isAdmin={true}>
    <div class="space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">Warehouse Management</h1>
                <p class="text-white/70">Edit warehouse vehicles and equipment</p>
            </div>
            <div class="flex gap-4">
                <a href="/warehouse" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                    View Warehouse
                </a>
                <button id="saveBtn" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                    Save Changes
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden rounded-lg p-4 border">
        </div>

        <!-- Add New Vehicle Button -->
        <button id="addCategoryBtn" class="w-full py-4 border-2 border-dashed border-white/30 rounded-lg hover:border-primary hover:bg-white/5 transition-colors text-white/70 hover:text-white">
            + Add New Vehicle
        </button>

        <!-- Group Order Section -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl font-bold">Group Management</h2>
                    <p class="text-white/60 text-sm">Create, rename, reorder, or delete vehicle groups</p>
                </div>
                <button id="addGroupBtn" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors text-sm font-semibold">
                    + Add Group
                </button>
            </div>
            <div id="groupOrderList" class="space-y-2">
                <!-- Groups will be rendered here -->
            </div>
        </div>

        <!-- Vehicles List -->
        <div id="categoriesList" class="space-y-6">
            <div class="text-center py-12 text-white/60">
                Loading warehouse data...
            </div>
        </div>
    </div>

    <script type="module">
        let adminUser = null;

        // Check permissions via server-side session
        async function validateSessionAndPermissions() {
            try {
                const response = await fetch('/api/auth/session', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/admin/login';
                    return false;
                }

                adminUser = data.user;

                // Check permission
                if (!hasPermission()) {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center bg-slate-900">
                            <div class="text-center p-8">
                                <h1 class="text-3xl font-bold text-red-400 mb-4">Access Denied</h1>
                                <p class="text-white/70 mb-4">You don't have permission to access this page.</p>
                                <a href="/admin" class="px-6 py-2 bg-primary hover:bg-primary/80 rounded-lg">Return to Dashboard</a>
                            </div>
                        </div>
                    `;
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                window.location.href = '/admin/login';
                return false;
            }
        }

        function hasPermission() {
            if (!adminUser) return false;
            if (adminUser.role === 'super_admin') return true;
            return adminUser.permissions && adminUser.permissions.includes('warehouse');
        }

        const icons = ['vehicle', 'firearm', 'communication', 'protection', 'investigation', 'traffic'];
        const flagColors = ['blue', 'red', 'green', 'yellow', 'purple', 'orange', 'pink', 'cyan', 'indigo', 'teal'];
        const defaultVehicleGroups = ['Training', 'Patrol', 'Heat', 'Air-1/Air-Tac', 'Transport', 'Supervisor/Command', 'S.W.A.T.', 'Other'];
        const MAX_FLAGS = 10;
        const MAX_IMAGES = 10;

        let warehouseData = [];
        let groupOrder = [...defaultVehicleGroups];
        let draggedGroupIndex = null;

        // Load warehouse data
        async function loadWarehouse() {
            try {
                const response = await fetch('/api/warehouse');
                const data = await response.json();
                warehouseData = data.warehouse || [];
                groupOrder = data.groupOrder || [...defaultVehicleGroups];
                renderGroupOrder();
                renderCategories();
            } catch (error) {
                console.error('Failed to load warehouse:', error);
                showStatus('Failed to load warehouse data', 'error');
                warehouseData = [];
                groupOrder = [...defaultVehicleGroups];
                renderGroupOrder();
                renderCategories();
            }
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `rounded-lg p-4 border ${type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-green-500/20 border-green-500/50 text-green-200'}`;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }

        function generateId(name) {
            return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderGroupOrder() {
            const container = document.getElementById('groupOrderList');
            container.innerHTML = groupOrder.map((group, index) => `
                <div class="group-item flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg border border-slate-600 hover:bg-slate-700 transition-colors"
                     data-group-index="${index}">
                    <div class="flex-shrink-0 text-white/40 cursor-move drag-handle">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                        </svg>
                    </div>
                    <input type="text" value="${escapeHtml(group)}" class="group-name-input flex-grow px-3 py-1 bg-slate-700/50 border border-slate-600 rounded text-white focus:ring-2 focus:ring-primary focus:border-transparent" data-group-index="${index}">
                    <span class="text-white/40 text-sm">#${index + 1}</span>
                    <button class="delete-group p-2 text-red-400 hover:text-red-300 transition-colors" data-group-index="${index}" title="Delete group">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');

            attachGroupDragListeners();
            attachGroupEditListeners();
        }

        function attachGroupEditListeners() {
            // Group name changes
            document.querySelectorAll('.group-name-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.groupIndex);
                    const oldName = groupOrder[index];
                    const newName = e.target.value.trim();
                    if (newName && newName !== oldName) {
                        groupOrder[index] = newName;
                        // Update any vehicles that had the old group name
                        warehouseData.forEach(vehicle => {
                            if (vehicle.group === oldName) {
                                vehicle.group = newName;
                            }
                        });
                        renderCategories(); // Re-render to update dropdowns
                    } else if (!newName) {
                        // Restore old name if empty
                        e.target.value = oldName;
                    }
                });
            });

            // Delete group buttons
            document.querySelectorAll('.delete-group').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('[data-group-index]').dataset.groupIndex);
                    const groupName = groupOrder[index];

                    // Count vehicles in this group
                    const vehiclesInGroup = warehouseData.filter(v => v.group === groupName).length;

                    let confirmMsg = `Are you sure you want to delete the "${groupName}" group?`;
                    if (vehiclesInGroup > 0) {
                        confirmMsg += `\n\n${vehiclesInGroup} vehicle(s) are assigned to this group. They will be unassigned.`;
                    }

                    if (confirm(confirmMsg)) {
                        // Remove from group order
                        groupOrder.splice(index, 1);
                        // Clear group from vehicles
                        warehouseData.forEach(vehicle => {
                            if (vehicle.group === groupName) {
                                vehicle.group = undefined;
                            }
                        });
                        renderGroupOrder();
                        renderCategories();
                    }
                });
            });
        }

        function attachGroupDragListeners() {
            const container = document.getElementById('groupOrderList');
            const items = container.querySelectorAll('.group-item');

            items.forEach(item => {
                // Make the item draggable
                item.setAttribute('draggable', 'true');

                item.addEventListener('dragstart', (e) => {
                    draggedGroupIndex = parseInt(e.target.closest('.group-item').dataset.groupIndex);
                    e.target.closest('.group-item').classList.add('opacity-50');
                });

                item.addEventListener('dragend', (e) => {
                    e.target.closest('.group-item').classList.remove('opacity-50');
                    draggedGroupIndex = null;
                    // Remove all drag-over styles
                    items.forEach(i => i.classList.remove('border-primary', 'border-t-2'));
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const targetIndex = parseInt(e.target.closest('.group-item')?.dataset.groupIndex);
                    if (targetIndex !== undefined && targetIndex !== draggedGroupIndex) {
                        e.target.closest('.group-item')?.classList.add('border-primary', 'border-t-2');
                    }
                });

                item.addEventListener('dragleave', (e) => {
                    e.target.closest('.group-item')?.classList.remove('border-primary', 'border-t-2');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetIndex = parseInt(e.target.closest('.group-item')?.dataset.groupIndex);
                    if (targetIndex !== undefined && draggedGroupIndex !== null && targetIndex !== draggedGroupIndex) {
                        // Reorder the groups
                        const draggedGroup = groupOrder[draggedGroupIndex];
                        groupOrder.splice(draggedGroupIndex, 1);
                        groupOrder.splice(targetIndex, 0, draggedGroup);
                        renderGroupOrder();
                        // Re-render categories to update group dropdowns
                        renderCategories();
                    }
                });
            });
        }

        function renderCategories() {
            const container = document.getElementById('categoriesList');

            if (warehouseData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-white/60">
                        No vehicles found. Add your first vehicle above.
                    </div>
                `;
                return;
            }

            container.innerHTML = warehouseData.map((vehicle, catIndex) => {
                const imageUrls = vehicle.imageUrls || [];
                const flags = vehicle.flags || [];
                const canAddMoreFlags = flags.length < MAX_FLAGS;
                const canAddMoreImages = imageUrls.length < MAX_IMAGES;

                return `
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20" data-category-index="${catIndex}">
                    <!-- Vehicle Header -->
                    <div class="flex items-start gap-4 mb-6">
                        <div class="w-12 h-12 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>

                        <div class="flex-grow space-y-4">
                            <!-- Row 1: Name and Icon -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1">Vehicle Name</label>
                                    <input type="text" value="${escapeHtml(vehicle.name)}" class="category-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-primary focus:border-transparent" data-category-index="${catIndex}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1">Group</label>
                                    <select class="vehicle-group w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-primary focus:border-transparent" data-category-index="${catIndex}">
                                        <option value="">Select Group...</option>
                                        ${groupOrder.map(group => `<option value="${group}" ${vehicle.group === group ? 'selected' : ''}>${group}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1">Icon</label>
                                    <select class="category-icon w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-primary focus:border-transparent" data-category-index="${catIndex}">
                                        ${icons.map(icon => `<option value="${icon}" ${vehicle.icon === icon ? 'selected' : ''}>${icon}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Row 2: Description -->
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-1">Description</label>
                                <textarea class="vehicle-description w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-primary focus:border-transparent resize-none" rows="2" data-category-index="${catIndex}" placeholder="Short description of the vehicle...">${escapeHtml(vehicle.description || '')}</textarea>
                            </div>

                            <!-- Row 3: Spawn Codes -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1">Spawn Code</label>
                                    <input type="text" value="${escapeHtml(vehicle.spawnCode || '')}" class="spawn-code w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-primary focus:border-transparent font-mono" data-category-index="${catIndex}" placeholder="e.g., 6653">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-1">Spawn By Model</label>
                                    <input type="text" value="${escapeHtml(vehicle.spawnByModel || '')}" class="spawn-by-model w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-primary focus:border-transparent font-mono" data-category-index="${catIndex}" placeholder="e.g., 11cvpitrain">
                                </div>
                            </div>

                            <!-- Flags Section -->
                            <div class="border border-slate-600 rounded-lg p-4 bg-slate-700/30">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-slate-300">Special Permission Flags (${flags.length}/${MAX_FLAGS})</label>
                                </div>
                                <p class="text-xs text-white/50 mb-3">Add flags for special permissions like Bulletproof, Nitrous, etc.</p>

                                <div class="space-y-2 mb-3">
                                    ${flags.map((flag, flagIndex) => `
                                        <div class="flex gap-2 items-center">
                                            <input type="text" value="${escapeHtml(flag.name)}" class="flag-name flex-grow px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent" data-category-index="${catIndex}" data-flag-index="${flagIndex}" placeholder="Flag name (e.g., Bulletproof)">
                                            <select class="flag-color w-28 px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent" data-category-index="${catIndex}" data-flag-index="${flagIndex}">
                                                ${flagColors.map(color => `<option value="${color}" ${flag.color === color ? 'selected' : ''}>${color}</option>`).join('')}
                                            </select>
                                            <button class="remove-flag p-2 text-red-400 hover:text-red-300 transition-colors" data-category-index="${catIndex}" data-flag-index="${flagIndex}" title="Remove flag">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>

                                ${canAddMoreFlags ? `
                                    <button class="add-flag w-full py-2 border-2 border-dashed border-slate-600 rounded-lg hover:border-primary hover:bg-white/5 transition-colors text-white/70 hover:text-white text-sm" data-category-index="${catIndex}">
                                        + Add Flag
                                    </button>
                                ` : `
                                    <span class="text-sm text-yellow-400">Max flags reached (10)</span>
                                `}
                            </div>

                            <!-- Image URLs Section -->
                            <div class="border border-slate-600 rounded-lg p-4 bg-slate-700/30">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-slate-300">Vehicle Images (${imageUrls.length}/${MAX_IMAGES})</label>
                                </div>
                                <p class="text-xs text-white/50 mb-3">Paste Discord CDN or Imgur image URLs below</p>

                                <div class="space-y-2 mb-3">
                                    ${imageUrls.map((url, imgIndex) => `
                                        <div class="flex gap-2 items-center">
                                            <div class="w-16 h-16 flex-shrink-0 bg-slate-800 rounded-lg overflow-hidden">
                                                <img src="${escapeHtml(url)}" alt="Preview ${imgIndex + 1}" class="w-full h-full object-cover" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23666%22><path d=%22M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z%22/></svg>'">
                                            </div>
                                            <input type="text" value="${escapeHtml(url)}" class="image-url flex-grow px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent" data-category-index="${catIndex}" data-url-index="${imgIndex}" placeholder="https://cdn.discordapp.com/... or https://i.imgur.com/...">
                                            <button class="remove-image-url p-2 text-red-400 hover:text-red-300 transition-colors" data-category-index="${catIndex}" data-url-index="${imgIndex}" title="Remove image">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>

                                ${canAddMoreImages ? `
                                    <button class="add-image-url w-full py-2 border-2 border-dashed border-slate-600 rounded-lg hover:border-primary hover:bg-white/5 transition-colors text-white/70 hover:text-white text-sm" data-category-index="${catIndex}">
                                        + Add Image URL
                                    </button>
                                ` : `
                                    <span class="text-sm text-yellow-400">Max images reached (10)</span>
                                `}
                            </div>

                            <button class="delete-category text-red-400 hover:text-red-300 text-sm" data-category-index="${catIndex}">
                                Delete Vehicle
                            </button>
                        </div>
                    </div>
                </div>
            `;}).join('');

            attachEventListeners();
        }

        function attachEventListeners() {
            // Vehicle name changes
            document.querySelectorAll('.category-name').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    warehouseData[index].name = e.target.value;
                    warehouseData[index].id = generateId(e.target.value);
                });
            });

            // Icon changes
            document.querySelectorAll('.category-icon').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    warehouseData[index].icon = e.target.value;
                });
            });

            // Group changes
            document.querySelectorAll('.vehicle-group').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    warehouseData[index].group = e.target.value || undefined;
                });
            });

            // Description changes
            document.querySelectorAll('.vehicle-description').forEach(textarea => {
                textarea.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    warehouseData[index].description = e.target.value;
                });
            });

            // Spawn code changes
            document.querySelectorAll('.spawn-code').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    warehouseData[index].spawnCode = e.target.value;
                });
            });

            // Spawn by model changes
            document.querySelectorAll('.spawn-by-model').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    warehouseData[index].spawnByModel = e.target.value;
                });
            });

            // Flag name changes
            document.querySelectorAll('.flag-name').forEach(input => {
                input.addEventListener('change', (e) => {
                    const catIndex = parseInt(e.target.dataset.categoryIndex);
                    const flagIndex = parseInt(e.target.dataset.flagIndex);
                    if (!warehouseData[catIndex].flags) warehouseData[catIndex].flags = [];
                    warehouseData[catIndex].flags[flagIndex].name = e.target.value;
                });
            });

            // Flag color changes
            document.querySelectorAll('.flag-color').forEach(select => {
                select.addEventListener('change', (e) => {
                    const catIndex = parseInt(e.target.dataset.categoryIndex);
                    const flagIndex = parseInt(e.target.dataset.flagIndex);
                    if (!warehouseData[catIndex].flags) warehouseData[catIndex].flags = [];
                    warehouseData[catIndex].flags[flagIndex].color = e.target.value;
                });
            });

            // Add flag
            document.querySelectorAll('.add-flag').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const catIndex = parseInt(e.target.dataset.categoryIndex);
                    if (!warehouseData[catIndex].flags) warehouseData[catIndex].flags = [];
                    if (warehouseData[catIndex].flags.length < MAX_FLAGS) {
                        warehouseData[catIndex].flags.push({ name: '', color: 'blue' });
                        renderCategories();
                    }
                });
            });

            // Remove flag
            document.querySelectorAll('.remove-flag').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const catIndex = parseInt(e.target.closest('[data-category-index]').dataset.categoryIndex);
                    const flagIndex = parseInt(e.target.closest('[data-flag-index]').dataset.flagIndex);
                    if (warehouseData[catIndex].flags) {
                        warehouseData[catIndex].flags.splice(flagIndex, 1);
                        renderCategories();
                    }
                });
            });

            // Delete vehicle
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.categoryIndex);
                    if (confirm('Are you sure you want to delete this vehicle?')) {
                        warehouseData.splice(index, 1);
                        renderCategories();
                    }
                });
            });

            // Image URL changes
            document.querySelectorAll('.image-url').forEach(input => {
                input.addEventListener('change', (e) => {
                    const catIndex = parseInt(e.target.dataset.categoryIndex);
                    const urlIndex = parseInt(e.target.dataset.urlIndex);
                    if (!warehouseData[catIndex].imageUrls) {
                        warehouseData[catIndex].imageUrls = [];
                    }
                    warehouseData[catIndex].imageUrls[urlIndex] = e.target.value.trim();
                    renderCategories();
                });
            });

            // Add image URL
            document.querySelectorAll('.add-image-url').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const catIndex = parseInt(e.target.dataset.categoryIndex);
                    if (!warehouseData[catIndex].imageUrls) {
                        warehouseData[catIndex].imageUrls = [];
                    }
                    if (warehouseData[catIndex].imageUrls.length < MAX_IMAGES) {
                        warehouseData[catIndex].imageUrls.push('');
                        renderCategories();
                    }
                });
            });

            // Remove image URL
            document.querySelectorAll('.remove-image-url').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const catIndex = parseInt(e.target.closest('[data-category-index]').dataset.categoryIndex);
                    const urlIndex = parseInt(e.target.closest('[data-url-index]').dataset.urlIndex);
                    if (warehouseData[catIndex].imageUrls) {
                        warehouseData[catIndex].imageUrls.splice(urlIndex, 1);
                        renderCategories();
                    }
                });
            });
        }

        // Add new vehicle
        document.getElementById('addCategoryBtn').addEventListener('click', () => {
            const newVehicle = {
                id: 'new-vehicle-' + Date.now(),
                name: 'New Vehicle',
                icon: 'vehicle',
                description: '',
                spawnCode: '',
                spawnByModel: '',
                flags: [],
                items: [],
                imageUrls: []
            };
            warehouseData.push(newVehicle);
            renderCategories();
        });

        // Add new group
        document.getElementById('addGroupBtn').addEventListener('click', () => {
            const newGroupName = prompt('Enter new group name:');
            if (newGroupName && newGroupName.trim()) {
                const trimmedName = newGroupName.trim();
                // Check if group already exists
                if (groupOrder.includes(trimmedName)) {
                    showStatus(`Group "${trimmedName}" already exists`, 'error');
                    return;
                }
                groupOrder.push(trimmedName);
                renderGroupOrder();
                renderCategories(); // Update dropdowns
                showStatus(`Group "${trimmedName}" added`, 'success');
            }
        });

        // Save changes
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch('/api/warehouse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ warehouse: warehouseData, groupOrder: groupOrder }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Changes saved successfully!', 'success');
                } else {
                    showStatus(result.error || 'Failed to save changes', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save changes', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });

        // Initialize - validate session first
        validateSessionAndPermissions().then(valid => {
            if (valid) {
                loadWarehouse();
            }
        });
    </script>
</Layout>
