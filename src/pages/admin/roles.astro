---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin - Roles & Permissions Management" isAdmin={true}>
    <div class="space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">Roles & Permissions</h1>
                <p class="text-white/70">Advanced role configuration with page-level access control</p>
            </div>
            <a href="/admin" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                Back to Dashboard
            </a>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden rounded-lg p-4 border">
        </div>

        <!-- Discord Role Mappings Section -->
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <div class="flex items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-400">Discord Role Mappings</h2>
                        <p class="text-white/60">Map Discord roles to granular page-level permissions</p>
                    </div>
                </div>
                <button id="addRoleMappingBtn" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 rounded-lg transition-colors font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Role Mapping
                </button>
            </div>

            <div id="roleMappingsList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    <svg class="w-8 h-8 mx-auto mb-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Loading role mappings...
                </div>
            </div>
        </div>

        <!-- Page Permissions Overview -->
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-emerald-400">Available Pages & Actions</h2>
                    <p class="text-white/60">Pages that can be configured with granular permissions</p>
                </div>
            </div>

            <div id="pageDefinitionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center py-8 text-white/60 col-span-full">
                    Loading page definitions...
                </div>
            </div>
        </div>

        <!-- Information Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- How It Works Card -->
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-blue-400">How It Works</h2>
                        <p class="text-white/60">Understanding advanced permissions</p>
                    </div>
                </div>

                <div class="space-y-4 text-white/80 text-sm">
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-teal-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-teal-400 text-xs font-bold">1</span>
                        </div>
                        <p><strong>Page Permissions:</strong> Control what each role can do on specific pages (view, create, edit, delete)</p>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-teal-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-teal-400 text-xs font-bold">2</span>
                        </div>
                        <p><strong>Field Restrictions:</strong> Limit access to specific fields within a page</p>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-teal-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-teal-400 text-xs font-bold">3</span>
                        </div>
                        <p><strong>Conditions:</strong> Add restrictions like "own items only" or "requires approval"</p>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 bg-teal-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-teal-400 text-xs font-bold">4</span>
                        </div>
                        <p><strong>Super Admin</strong> always has full access. <strong>Custom</strong> roles use assigned permissions only.</p>
                    </div>
                </div>
            </div>

            <!-- Discord ID Help Card -->
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-purple-400">Finding Discord Role IDs</h2>
                        <p class="text-white/60">Get a Discord role ID</p>
                    </div>
                </div>

                <div class="space-y-2 text-white/80 text-sm">
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Enable <strong>Developer Mode</strong> in Discord Settings</li>
                        <li>Go to <strong>Server Settings > Roles</strong></li>
                        <li>Right-click on the role</li>
                        <li>Click <strong>"Copy Role ID"</strong></li>
                    </ol>
                    <p class="mt-2 text-xs">Example: <code class="bg-slate-700 px-2 py-0.5 rounded text-cyan-300">123456789012345678</code></p>
                </div>
            </div>
        </div>

        <!-- Legacy Permissions Section -->
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-green-400">Legacy Permissions (Backward Compatible)</h2>
                    <p class="text-white/60">Simple permission toggles for basic access control</p>
                </div>
            </div>

            <div id="permissionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center py-8 text-white/60 col-span-full">
                    Loading permissions...
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Role Mapping Modal -->
    <div id="roleMappingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-slate-600">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold">Add Role Mapping</h3>
                <button id="closeModalBtn" class="text-white/60 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="roleMappingForm" class="space-y-6">
                <input type="hidden" id="roleMappingId" value="">

                <!-- Basic Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Discord Role ID *</label>
                        <input type="text" id="discordRoleId" required
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-indigo-500"
                            placeholder="123456789012345678">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Role Name *</label>
                        <input type="text" id="roleName" required
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-indigo-500"
                            placeholder="High Command">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Description</label>
                        <input type="text" id="roleDescription"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-indigo-500"
                            placeholder="Full administrative access">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-white/80 mb-1">Internal Role Type *</label>
                            <select id="internalRole" required
                                class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-indigo-500">
                                <option value="super_admin">Super Admin</option>
                                <option value="subdivision_overseer">Subdivision Overseer</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-white/80 mb-1">Priority</label>
                            <input type="number" id="rolePriority" min="0" max="100"
                                class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-indigo-500"
                                placeholder="10" value="10">
                        </div>
                    </div>
                </div>

                <!-- Role Active Toggle -->
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="roleActive" checked
                        class="w-5 h-5 rounded bg-slate-600 border-slate-500 text-indigo-500 focus:ring-indigo-500">
                    <label for="roleActive" class="text-sm font-medium text-white/80">Role is Active</label>
                    <span class="text-xs text-white/50">(Inactive roles are ignored during login)</span>
                </div>

                <!-- Page Permissions Section -->
                <div id="pagePermissionsSection" class="border-t border-slate-600 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Page-Level Permissions</h4>
                            <p class="text-sm text-white/50">Configure what this role can do on each page</p>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" id="selectAllPagesBtn" class="text-xs px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded transition-colors">
                                Select All
                            </button>
                            <button type="button" id="clearAllPagesBtn" class="text-xs px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded transition-colors">
                                Clear All
                            </button>
                        </div>
                    </div>

                    <div id="pagePermissionsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto bg-slate-900/30 rounded-lg p-4">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Legacy Permissions Section (collapsible) -->
                <div class="border-t border-slate-600 pt-6">
                    <button type="button" id="toggleLegacyPerms" class="flex items-center gap-2 text-sm text-white/70 hover:text-white">
                        <svg id="legacyPermsChevron" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        Legacy Permissions (for backward compatibility)
                    </button>
                    <div id="legacyPermsContainer" class="hidden mt-4">
                        <div id="permissionsCheckboxes" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto bg-slate-900/50 rounded-lg p-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 pt-4 border-t border-slate-600">
                    <button type="submit" id="saveRoleMappingBtn"
                        class="flex-1 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 rounded-lg transition-colors font-semibold">
                        Save Role Mapping
                    </button>
                    <button type="button" id="cancelModalBtn"
                        class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        let adminUser = null;
        let rolesConfig = null;

        // Action labels and icons
        const actionLabels = {
            view: { label: 'View', icon: 'üëÅÔ∏è', color: 'bg-blue-500/20 text-blue-300' },
            create: { label: 'Create', icon: '‚ûï', color: 'bg-green-500/20 text-green-300' },
            edit: { label: 'Edit', icon: '‚úèÔ∏è', color: 'bg-yellow-500/20 text-yellow-300' },
            delete: { label: 'Delete', icon: 'üóëÔ∏è', color: 'bg-red-500/20 text-red-300' },
            manage: { label: 'Manage', icon: '‚öôÔ∏è', color: 'bg-purple-500/20 text-purple-300' },
        };

        // Condition labels
        const conditionLabels = {
            own_items_only: 'Own items only',
            max_per_day: 'Max per day limit',
            requires_approval: 'Requires approval',
            time_restricted: 'Time restricted',
        };

        async function validateSessionAndPermissions() {
            try {
                const response = await fetch('/api/auth/session', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/admin/login';
                    return false;
                }

                adminUser = data.user;

                if (adminUser.role !== 'super_admin') {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center bg-slate-900">
                            <div class="text-center p-8">
                                <h1 class="text-3xl font-bold text-red-400 mb-4">Access Denied</h1>
                                <p class="text-white/70 mb-4">Only Super Admins can access this page.</p>
                                <a href="/admin" class="px-6 py-2 bg-primary hover:bg-primary/80 rounded-lg">Return to Dashboard</a>
                            </div>
                        </div>
                    `;
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                window.location.href = '/admin/login';
                return false;
            }
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `rounded-lg p-4 border ${type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-green-500/20 border-green-500/50 text-green-200'}`;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }

        async function loadRolesConfig() {
            try {
                const response = await fetch('/api/roles-config');
                const data = await response.json();

                if (data.success) {
                    rolesConfig = data.config;
                    renderRoleMappings();
                    renderPageDefinitions();
                    renderLegacyPermissions();
                } else {
                    showStatus(data.error || 'Failed to load roles configuration', 'error');
                }
            } catch (error) {
                console.error('Error loading roles config:', error);
                showStatus('Failed to load roles configuration', 'error');
            }
        }

        function renderRoleMappings() {
            const container = document.getElementById('roleMappingsList');

            if (!rolesConfig.discordRoleMappings || rolesConfig.discordRoleMappings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        <p>No Discord role mappings configured.</p>
                        <p class="text-sm mt-2">Click "Add Role Mapping" to configure page-level permissions.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rolesConfig.discordRoleMappings.map(mapping => {
                const pagePermsCount = mapping.pagePermissions?.length || 0;
                const legacyPermsCount = mapping.permissions?.length || 0;

                return `
                <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-600/50 ${mapping.isActive === false ? 'opacity-50' : ''}" data-id="${mapping.id}">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2 flex-wrap">
                                <h3 class="text-lg font-bold text-white">${mapping.roleName}</h3>
                                <span class="px-2 py-0.5 text-xs rounded-full ${
                                    mapping.internalRole === 'super_admin' ? 'bg-red-500/20 text-red-300' :
                                    mapping.internalRole === 'subdivision_overseer' ? 'bg-yellow-500/20 text-yellow-300' :
                                    'bg-blue-500/20 text-blue-300'
                                }">
                                    ${mapping.internalRole === 'super_admin' ? 'Super Admin' :
                                      mapping.internalRole === 'subdivision_overseer' ? 'Subdivision Overseer' : 'Custom'}
                                </span>
                                <span class="px-2 py-0.5 text-xs bg-slate-600 rounded-full">Priority: ${mapping.priority}</span>
                                ${mapping.isActive === false ? '<span class="px-2 py-0.5 text-xs bg-red-500/30 text-red-300 rounded-full">Inactive</span>' : ''}
                            </div>
                            <p class="text-sm text-white/60 mb-2">${mapping.description || 'No description'}</p>
                            <div class="flex flex-wrap gap-2 text-xs mb-2">
                                <span class="text-white/50">Discord Role ID:</span>
                                <code class="bg-slate-700 px-2 py-0.5 rounded text-cyan-300">${mapping.discordRoleIdMasked || mapping.discordRoleId}</code>
                            </div>

                            <!-- Permission summary -->
                            <div class="flex flex-wrap gap-2 text-xs">
                                ${pagePermsCount > 0 ? `
                                    <span class="px-2 py-1 bg-emerald-500/20 text-emerald-300 rounded-full">
                                        ${pagePermsCount} page permissions
                                    </span>
                                ` : ''}
                                ${legacyPermsCount > 0 ? `
                                    <span class="px-2 py-1 bg-green-500/20 text-green-300 rounded-full">
                                        ${legacyPermsCount} legacy permissions
                                    </span>
                                ` : ''}
                                ${pagePermsCount === 0 && legacyPermsCount === 0 && mapping.internalRole !== 'super_admin' ? `
                                    <span class="px-2 py-1 bg-orange-500/20 text-orange-300 rounded-full">
                                        No permissions configured
                                    </span>
                                ` : ''}
                            </div>

                            <!-- Show page permissions if any -->
                            ${mapping.pagePermissions && mapping.pagePermissions.length > 0 ? `
                                <div class="mt-2 flex flex-wrap gap-1">
                                    ${mapping.pagePermissions.slice(0, 5).map(pp => {
                                        const page = rolesConfig.pageDefinitions?.find(p => p.id === pp.pageId);
                                        return `<span class="px-2 py-0.5 text-xs bg-emerald-500/20 text-emerald-300 rounded">${page?.name || pp.pageId}: ${pp.actions.join(', ')}</span>`;
                                    }).join('')}
                                    ${mapping.pagePermissions.length > 5 ? `<span class="px-2 py-0.5 text-xs bg-slate-600 rounded">+${mapping.pagePermissions.length - 5} more</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editRoleMapping('${mapping.id}')" class="p-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="deleteRoleMapping('${mapping.id}')" class="p-2 bg-red-500/30 hover:bg-red-500/50 rounded-lg transition-colors" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderPageDefinitions() {
            const container = document.getElementById('pageDefinitionsList');
            const pageGrid = document.getElementById('pagePermissionsGrid');

            if (!rolesConfig.pageDefinitions || rolesConfig.pageDefinitions.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-white/60 col-span-full">No page definitions available.</div>`;
                return;
            }

            // Group by category
            const categories = {};
            rolesConfig.pageDefinitions.forEach(page => {
                if (!categories[page.category]) categories[page.category] = [];
                categories[page.category].push(page);
            });

            // Render page definitions overview
            container.innerHTML = Object.entries(categories).map(([cat, pages]) => `
                <div class="col-span-full">
                    <h4 class="text-sm font-semibold text-white/60 uppercase tracking-wide mb-2">${cat}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-4">
                        ${pages.map(page => `
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-600/50">
                                <div class="font-medium text-white text-sm">${page.name}</div>
                                <div class="text-xs text-white/50 mb-1">${page.description}</div>
                                <div class="flex flex-wrap gap-1">
                                    ${page.availableActions.map(action => `
                                        <span class="px-1.5 py-0.5 text-xs rounded ${actionLabels[action]?.color || 'bg-gray-500/20 text-gray-300'}">${action}</span>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Render page permissions checkboxes for modal
            pageGrid.innerHTML = rolesConfig.pageDefinitions.map(page => `
                <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700" data-page-id="${page.id}">
                    <div class="flex items-center gap-2 mb-2">
                        <input type="checkbox" class="page-toggle rounded bg-slate-600" data-page="${page.id}">
                        <span class="font-medium text-white text-sm">${page.name}</span>
                    </div>
                    <div class="page-actions hidden pl-4 space-y-2" data-page="${page.id}">
                        <div class="flex flex-wrap gap-2">
                            ${page.availableActions.map(action => `
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" class="action-checkbox rounded bg-slate-600 w-4 h-4" data-page="${page.id}" data-action="${action}">
                                    <span class="text-xs ${actionLabels[action]?.color || ''} px-1.5 py-0.5 rounded">${action}</span>
                                </label>
                            `).join('')}
                        </div>

                        ${page.restrictableFields && page.restrictableFields.length > 0 ? `
                            <div class="mt-2 pt-2 border-t border-slate-700">
                                <div class="text-xs text-white/50 mb-1">Restrict to fields:</div>
                                <div class="flex flex-wrap gap-1">
                                    ${page.restrictableFields.map(field => `
                                        <label class="flex items-center gap-1 cursor-pointer text-xs">
                                            <input type="checkbox" class="field-checkbox rounded bg-slate-600 w-3 h-3" data-page="${page.id}" data-field="${field.id}">
                                            <span class="text-white/70">${field.name}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${page.availableConditions && page.availableConditions.length > 0 ? `
                            <div class="mt-2 pt-2 border-t border-slate-700">
                                <div class="text-xs text-white/50 mb-1">Conditions:</div>
                                <div class="flex flex-wrap gap-1">
                                    ${page.availableConditions.map(cond => `
                                        <label class="flex items-center gap-1 cursor-pointer text-xs">
                                            <input type="checkbox" class="condition-checkbox rounded bg-slate-600 w-3 h-3" data-page="${page.id}" data-condition="${cond}">
                                            <span class="text-orange-300">${conditionLabels[cond] || cond}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Add event listeners for page toggles
            document.querySelectorAll('.page-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const pageId = e.target.dataset.page;
                    const actionsContainer = document.querySelector(`.page-actions[data-page="${pageId}"]`);
                    if (e.target.checked) {
                        actionsContainer.classList.remove('hidden');
                        // Auto-check "view" action
                        const viewCheckbox = actionsContainer.querySelector(`input[data-action="view"]`);
                        if (viewCheckbox) viewCheckbox.checked = true;
                    } else {
                        actionsContainer.classList.add('hidden');
                        // Uncheck all actions
                        actionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    }
                });
            });
        }

        function renderLegacyPermissions() {
            const container = document.getElementById('permissionsList');
            const checkboxContainer = document.getElementById('permissionsCheckboxes');

            const categories = {
                content: { name: 'Content Management', items: [] },
                webhook: { name: 'Webhooks', items: [] },
                admin: { name: 'Administration', items: [] },
                other: { name: 'Other', items: [] }
            };

            rolesConfig.availablePermissions?.forEach(perm => {
                const cat = categories[perm.category] || categories.other;
                cat.items.push(perm);
            });

            container.innerHTML = Object.entries(categories)
                .filter(([_, cat]) => cat.items.length > 0)
                .map(([key, cat]) => `
                    <div class="col-span-full">
                        <h4 class="text-sm font-semibold text-white/60 uppercase tracking-wide mb-2">${cat.name}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-4">
                            ${cat.items.map(perm => `
                                <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-600/50">
                                    <div class="font-medium text-white text-sm">${perm.name}</div>
                                    <div class="text-xs text-white/50">${perm.description}</div>
                                    <code class="text-xs text-cyan-300">${perm.id}</code>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

            checkboxContainer.innerHTML = rolesConfig.availablePermissions?.map(perm => `
                <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-800 p-1 rounded">
                    <input type="checkbox" name="permissions" value="${perm.id}" class="rounded bg-slate-600 border-slate-500">
                    <span class="text-sm">${perm.name}</span>
                </label>
            `).join('') || '';
        }

        function getPagePermissionsFromForm() {
            const pagePermissions = [];

            document.querySelectorAll('.page-toggle:checked').forEach(toggle => {
                const pageId = toggle.dataset.page;
                const actions = [];
                const allowedFields = [];
                const conditions = [];

                document.querySelectorAll(`.action-checkbox[data-page="${pageId}"]:checked`).forEach(cb => {
                    actions.push(cb.dataset.action);
                });

                document.querySelectorAll(`.field-checkbox[data-page="${pageId}"]:checked`).forEach(cb => {
                    allowedFields.push(cb.dataset.field);
                });

                document.querySelectorAll(`.condition-checkbox[data-page="${pageId}"]:checked`).forEach(cb => {
                    conditions.push({ type: cb.dataset.condition });
                });

                if (actions.length > 0) {
                    const pagePerm = { pageId, actions };
                    if (allowedFields.length > 0 || conditions.length > 0) {
                        pagePerm.restrictions = {};
                        if (allowedFields.length > 0) pagePerm.restrictions.allowedFields = allowedFields;
                        if (conditions.length > 0) pagePerm.restrictions.conditions = conditions;
                    }
                    pagePermissions.push(pagePerm);
                }
            });

            return pagePermissions;
        }

        function setPagePermissionsInForm(pagePermissions) {
            // Reset all
            document.querySelectorAll('.page-toggle').forEach(t => t.checked = false);
            document.querySelectorAll('.page-actions').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.action-checkbox, .field-checkbox, .condition-checkbox').forEach(cb => cb.checked = false);

            if (!pagePermissions) return;

            pagePermissions.forEach(pp => {
                const toggle = document.querySelector(`.page-toggle[data-page="${pp.pageId}"]`);
                if (toggle) {
                    toggle.checked = true;
                    const actionsContainer = document.querySelector(`.page-actions[data-page="${pp.pageId}"]`);
                    actionsContainer?.classList.remove('hidden');

                    pp.actions?.forEach(action => {
                        const cb = document.querySelector(`.action-checkbox[data-page="${pp.pageId}"][data-action="${action}"]`);
                        if (cb) cb.checked = true;
                    });

                    pp.restrictions?.allowedFields?.forEach(field => {
                        const cb = document.querySelector(`.field-checkbox[data-page="${pp.pageId}"][data-field="${field}"]`);
                        if (cb) cb.checked = true;
                    });

                    pp.restrictions?.conditions?.forEach(cond => {
                        const cb = document.querySelector(`.condition-checkbox[data-page="${pp.pageId}"][data-condition="${cond.type}"]`);
                        if (cb) cb.checked = true;
                    });
                }
            });
        }

        function openModal(isEdit = false, mapping = null) {
            const modal = document.getElementById('roleMappingModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('roleMappingForm');

            title.textContent = isEdit ? 'Edit Role Mapping' : 'Add Role Mapping';

            if (isEdit && mapping) {
                document.getElementById('roleMappingId').value = mapping.id;
                document.getElementById('discordRoleId').value = mapping.discordRoleId;
                document.getElementById('roleName').value = mapping.roleName;
                document.getElementById('roleDescription').value = mapping.description || '';
                document.getElementById('internalRole').value = mapping.internalRole;
                document.getElementById('rolePriority').value = mapping.priority;
                document.getElementById('roleActive').checked = mapping.isActive !== false;

                // Set legacy permissions
                form.querySelectorAll('input[name="permissions"]').forEach(cb => {
                    cb.checked = mapping.permissions?.includes(cb.value) || false;
                });

                // Set page permissions
                setPagePermissionsInForm(mapping.pagePermissions);
            } else {
                form.reset();
                document.getElementById('roleMappingId').value = '';
                document.getElementById('rolePriority').value = '10';
                document.getElementById('roleActive').checked = true;
                setPagePermissionsInForm([]);
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('roleMappingModal').classList.add('hidden');
        }

        window.editRoleMapping = function(id) {
            const mapping = rolesConfig.discordRoleMappings.find(m => m.id === id);
            if (mapping) {
                openModal(true, mapping);
            }
        };

        window.deleteRoleMapping = async function(id) {
            if (!confirm('Are you sure you want to delete this role mapping?')) return;

            try {
                const response = await fetch('/api/roles-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteRoleMapping',
                        roleMappingId: id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('Role mapping deleted successfully');
                    await loadRolesConfig();
                } else {
                    showStatus(data.error || 'Failed to delete role mapping', 'error');
                }
            } catch (error) {
                console.error('Error deleting role mapping:', error);
                showStatus('Failed to delete role mapping', 'error');
            }
        };

        // Event listeners
        document.getElementById('addRoleMappingBtn').addEventListener('click', () => openModal(false));
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('cancelModalBtn').addEventListener('click', closeModal);

        document.getElementById('roleMappingModal').addEventListener('click', (e) => {
            if (e.target.id === 'roleMappingModal') closeModal();
        });

        // Toggle legacy permissions section
        document.getElementById('toggleLegacyPerms').addEventListener('click', () => {
            const container = document.getElementById('legacyPermsContainer');
            const chevron = document.getElementById('legacyPermsChevron');
            container.classList.toggle('hidden');
            chevron.classList.toggle('rotate-90');
        });

        // Select/clear all pages
        document.getElementById('selectAllPagesBtn')?.addEventListener('click', () => {
            document.querySelectorAll('.page-toggle').forEach(toggle => {
                toggle.checked = true;
                toggle.dispatchEvent(new Event('change'));
            });
        });

        document.getElementById('clearAllPagesBtn')?.addEventListener('click', () => {
            document.querySelectorAll('.page-toggle').forEach(toggle => {
                toggle.checked = false;
                toggle.dispatchEvent(new Event('change'));
            });
        });

        document.getElementById('roleMappingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roleMappingId = document.getElementById('roleMappingId').value;
            const isEdit = !!roleMappingId;

            const form = e.target;
            const selectedPermissions = Array.from(form.querySelectorAll('input[name="permissions"]:checked'))
                .map(cb => cb.value);

            const pagePermissions = getPagePermissionsFromForm();

            const roleMapping = {
                discordRoleId: document.getElementById('discordRoleId').value.trim(),
                roleName: document.getElementById('roleName').value.trim(),
                description: document.getElementById('roleDescription').value.trim(),
                internalRole: document.getElementById('internalRole').value,
                priority: parseInt(document.getElementById('rolePriority').value) || 10,
                permissions: selectedPermissions,
                pagePermissions: pagePermissions,
                isActive: document.getElementById('roleActive').checked,
            };

            try {
                const response = await fetch('/api/roles-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: isEdit ? 'updateRoleMapping' : 'addRoleMapping',
                        roleMapping,
                        roleMappingId: isEdit ? roleMappingId : undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(isEdit ? 'Role mapping updated successfully' : 'Role mapping added successfully');
                    closeModal();
                    await loadRolesConfig();
                } else {
                    showStatus(data.error || 'Failed to save role mapping', 'error');
                }
            } catch (error) {
                console.error('Error saving role mapping:', error);
                showStatus('Failed to save role mapping', 'error');
            }
        });

        // Initialize
        validateSessionAndPermissions().then(valid => {
            if (valid) {
                loadRolesConfig();
            }
        });
    </script>
</Layout>
