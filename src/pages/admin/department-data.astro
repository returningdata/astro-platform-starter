---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin - Department Data Management" isAdmin={true}>
    <div class="space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">Department Data</h1>
                <p class="text-white/70">Manage awards recipients and chain of command</p>
            </div>
            <div class="flex gap-4 flex-wrap">
                <a href="/admin" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                    Back to Dashboard
                </a>
                <button id="syncRosterBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition-colors font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Manual Sync
                </button>
                <button id="saveBtn" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                    Save Changes
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden rounded-lg p-4 border">
        </div>

        <!-- Sync Info Banner -->
        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="flex-1">
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <h3 class="font-semibold text-green-300">Roster Auto-Sync Enabled</h3>
                        <div class="flex items-center gap-2 text-sm">
                            <span id="autoSyncStatus" class="flex items-center gap-1.5 text-green-400">
                                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                Active
                            </span>
                            <span class="text-white/50">|</span>
                            <span id="lastSyncTime" class="text-white/70">Last sync: Never</span>
                            <span class="text-white/50">|</span>
                            <span id="nextSyncTime" class="text-white/70">Next: --:--</span>
                        </div>
                    </div>
                    <p class="text-sm text-white/70 mt-1">
                        Roster automatically syncs from the
                        <a href="https://docs.google.com/spreadsheets/d/1iUCnkFyPlNd5jorr3g2ZH2PLhwuQOcFXvx_DlbKdnI0/edit?gid=1853319408" target="_blank" class="text-green-400 hover:text-green-300 underline">DPPD Master Roster</a>
                        every minute. Data is auto-saved to the Chain of Command page.
                        Use "Manual Sync" to sync immediately.
                    </p>
                </div>
            </div>
        </div>

        <!-- Department Liaisons Section -->
        <div id="departmentLiaisonsSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-rose-400">Department Liaisons</h2>
                    <p class="text-white/60">Manage Department Liaisons that appear at the top of the Chain of Command. Up to 5 slots available.</p>
                </div>
            </div>
            <div id="departmentLiaisonsList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading department liaisons data...
                </div>
            </div>
        </div>

        <!-- Chain of Command Section - High Command -->
        <div id="commandSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <h2 class="text-2xl font-bold mb-4 text-teal-400">Chain of Command - High Command</h2>
            <p class="text-white/60 mb-6">Assign names and job titles to high command positions.</p>

            <div id="commandList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading chain of command data...
                </div>
            </div>
        </div>

        <!-- Rank-Based Positions Sections -->
        <div id="rankPositionsSections" class="space-y-6">
            <div class="text-center py-8 text-white/60">
                Loading rank positions data...
            </div>
        </div>

        <!-- Subdivision Leadership Section -->
        <div id="subdivisionSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-orange-400">Subdivision Leadership</h2>
                    <p class="text-white/60">Assign heads to each subdivision. Enter name, callsign, and job title.</p>
                </div>
                <button id="addSubdivisionBtn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Subdivision
                </button>
            </div>

            <div id="subdivisionList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading subdivision data...
                </div>
            </div>
        </div>

        <!-- Awards Recipients Section -->
        <div id="awardsSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Recent Awards & Recognition</h2>
            <p class="text-white/60 mb-6">Assign recipient names to awards. Names will appear in italic on the About page.</p>

            <div id="awardsList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading awards data...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let adminUser = null;

        async function validateSessionAndPermissions() {
            try {
                const response = await fetch('/api/auth/session', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/admin/login';
                    return false;
                }

                adminUser = data.user;

                // Check if user has permission for department data
                if (!hasFullPermission() && !hasSubdivisionOnlyPermission()) {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center bg-slate-900">
                            <div class="text-center p-8">
                                <h1 class="text-3xl font-bold text-red-400 mb-4">Access Denied</h1>
                                <p class="text-white/70 mb-4">You don't have permission to access this page.</p>
                                <a href="/admin" class="px-6 py-2 bg-primary hover:bg-primary/80 rounded-lg">Return to Dashboard</a>
                            </div>
                        </div>
                    `;
                    return false;
                }

                // Hide sections that subdivision overseer shouldn't see
                const isSubdivisionOnly = !hasFullPermission() && hasSubdivisionOnlyPermission();
                if (isSubdivisionOnly) {
                    // Hide chain of command, rank positions, and awards sections
                    const commandSection = document.getElementById('commandSection');
                    const rankSection = document.getElementById('rankPositionsSections');
                    const awardsSection = document.getElementById('awardsSection');

                    if (commandSection) commandSection.style.display = 'none';
                    if (rankSection) rankSection.style.display = 'none';
                    if (awardsSection) awardsSection.style.display = 'none';
                }

                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                window.location.href = '/admin/login';
                return false;
            }
        }

        // Check if user has permission for department data
        function hasFullPermission() {
            if (!adminUser) return false;
            if (adminUser.role === 'super_admin') return true;
            return adminUser.permissions && adminUser.permissions.includes('department-data');
        }

        function hasSubdivisionOnlyPermission() {
            if (!adminUser) return false;
            if (adminUser.role === 'subdivision_overseer') return true;
            return adminUser.permissions && adminUser.permissions.includes('department-data-subdivisions');
        }

        let departmentData = {
            awardRecipients: [],
            commandPositions: [],
            tierPositions: [],
            rankPositions: [],
            subdivisionLeadership: []
        };

        let availableSubdivisions = [];

        // Default award recipients structure
        const defaultAwardRecipients = [
            { awardName: 'Medal of Valor', recipientName: '' },
            { awardName: 'Distinguished Service Medal', recipientName: '' },
            { awardName: 'Service Medal', recipientName: '' },
            { awardName: 'Gold Medal of Excellence', recipientName: '' },
            { awardName: 'Meritorious Medal', recipientName: '' },
            { awardName: 'Academy Officer Service Medal', recipientName: '' },
            { awardName: 'Supervisor of the Month', recipientName: '' },
            { awardName: 'Supervisor of the Week', recipientName: '' },
            { awardName: 'Officer of the Month', recipientName: '' },
            { awardName: 'Officer of the Week', recipientName: '' },
            { awardName: 'Training Officer of the Week', recipientName: '' },
            { awardName: 'Photo of the Week', recipientName: '', imageUrl: '' }
        ];

        // Default rank positions structure
        const defaultRankPositions = [
            {
                rank: 'Major',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Captain',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: '1st Lieutenant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: '2nd Lieutenant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Master Sergeant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Sergeant First Class',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Staff Sergeant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Sergeant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Corporal',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Officer III',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Officer II',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Officer I',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Probationary Officer',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Reserve Officer',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Cadet',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            }
        ];

        // Default command positions structure
        const defaultCommandPositions = [
            { rank: 'Chief of Police', name: '', callSign: '1R-01', jobTitle: '' },
            { rank: 'Deputy Chief of Police', name: '', callSign: '1R-02', jobTitle: '' },
            { rank: 'Assistant Chief of Police', name: '', callSign: '1R-03', jobTitle: '' },
            { rank: 'Colonel', name: '', callSign: '1R-04', jobTitle: '' },
            { rank: 'Lieutenant Colonel', name: '', callSign: '1R-05', jobTitle: '' },
            { rank: 'Commander', name: '', callSign: '1R-06', jobTitle: '' }
        ];

        // Default subdivision leadership structure
        const defaultSubdivisionLeadership = [
            { division: 'Department Liaison', name: '', callSign: '', jobTitle: '', positionType: 'department_liaison' },
            { division: 'Department Liaison', name: '', callSign: '', jobTitle: '', positionType: 'department_liaison' },
            { division: 'Department Liaison', name: '', callSign: '', jobTitle: '', positionType: 'department_liaison' },
            { division: 'Department Liaison', name: '', callSign: '', jobTitle: '', positionType: 'department_liaison' },
            { division: 'Department Liaison', name: '', callSign: '', jobTitle: '', positionType: 'department_liaison' },
            { division: 'Subdivision Overseer', name: '', callSign: '', jobTitle: '', positionType: 'overseer' },
            { division: 'Assistant Head of Subdivisions', name: '', callSign: '', jobTitle: '', positionType: 'assistant_head' },
            { division: 'Field Training Division', name: '', callSign: '', jobTitle: '', positionType: 'leader' },
            { division: 'Special Weapons and Tactics', name: '', callSign: '', jobTitle: '', positionType: 'leader' },
            { division: 'Traffic Enforcement Unit', name: '', callSign: '', jobTitle: '', positionType: 'leader' },
            { division: 'Criminal Investigations Unit', name: '', callSign: '', jobTitle: '', positionType: 'leader' },
            { division: 'K9 Division', name: '', callSign: '', jobTitle: '', positionType: 'leader' }
        ];

        // Rank colors for styling
        const rankColors = {
            'Major': { color: 'blue', tier: 'Low Command' },
            'Captain': { color: 'blue', tier: 'Low Command' },
            '1st Lieutenant': { color: 'blue', tier: 'Low Command' },
            '2nd Lieutenant': { color: 'blue', tier: 'Low Command' },
            'Master Sergeant': { color: 'indigo', tier: 'Trial Low Command' },
            'Sergeant First Class': { color: 'purple', tier: 'Supervisors' },
            'Staff Sergeant': { color: 'purple', tier: 'Supervisors' },
            'Sergeant': { color: 'purple', tier: 'Supervisors' },
            'Corporal': { color: 'violet', tier: 'Trial Supervisor' },
            'Officer III': { color: 'amber', tier: 'Officers' },
            'Officer II': { color: 'amber', tier: 'Officers' },
            'Officer I': { color: 'amber', tier: 'Officers' },
            'Probationary Officer': { color: 'amber', tier: 'Officers' },
            'Reserve Officer': { color: 'lime', tier: 'Reserves' },
            'Cadet': { color: 'green', tier: 'Cadets' }
        };

        // Load department data
        async function loadDepartmentData() {
            try {
                // Load subdivisions first
                const subResponse = await fetch('/api/subdivisions');
                const subData = await subResponse.json();
                availableSubdivisions = subData.subdivisions || [];

                const response = await fetch('/api/department-data');
                const data = await response.json();
                departmentData = data;

                // Ensure rankPositions exists with proper structure
                if (!departmentData.rankPositions || departmentData.rankPositions.length === 0) {
                    departmentData.rankPositions = defaultRankPositions;
                }

                // Ensure each rank position has 6 members
                departmentData.rankPositions = departmentData.rankPositions.map(rp => {
                    while (rp.members.length < 6) {
                        rp.members.push({ name: '', callSign: '', jobTitle: '' });
                    }
                    return rp;
                });

                // Ensure command positions exists with all default positions
                if (!departmentData.commandPositions || departmentData.commandPositions.length === 0) {
                    departmentData.commandPositions = defaultCommandPositions;
                } else {
                    // Ensure all default command positions exist
                    const existingRanks = new Set(departmentData.commandPositions.map(cp => cp.rank));
                    for (const defaultPos of defaultCommandPositions) {
                        if (!existingRanks.has(defaultPos.rank)) {
                            // Find the correct position to insert the missing command position
                            const defaultIndex = defaultCommandPositions.findIndex(cp => cp.rank === defaultPos.rank);
                            departmentData.commandPositions.splice(defaultIndex, 0, { ...defaultPos });
                        }
                    }
                    // Ensure all have jobTitle field
                    departmentData.commandPositions = departmentData.commandPositions.map(cp => ({
                        ...cp,
                        jobTitle: cp.jobTitle || ''
                    }));
                }

                // Ensure subdivisionLeadership exists
                if (!departmentData.subdivisionLeadership || departmentData.subdivisionLeadership.length === 0) {
                    departmentData.subdivisionLeadership = defaultSubdivisionLeadership;
                }

                // Ensure awardRecipients exists with all default awards
                if (!departmentData.awardRecipients || departmentData.awardRecipients.length === 0) {
                    departmentData.awardRecipients = defaultAwardRecipients.map(a => ({ ...a }));
                } else {
                    // Ensure all default awards exist in the stored data
                    const existingAwards = new Set(departmentData.awardRecipients.map(a => a.awardName));
                    for (const defaultAward of defaultAwardRecipients) {
                        if (!existingAwards.has(defaultAward.awardName)) {
                            // Find the correct position to insert the missing award
                            const defaultIndex = defaultAwardRecipients.findIndex(a => a.awardName === defaultAward.awardName);
                            departmentData.awardRecipients.splice(defaultIndex, 0, { ...defaultAward });
                        }
                    }
                }

                renderCommandPositions();
                renderRankPositions();
                renderDepartmentLiaisons();
                renderSubdivisionLeadership();
                renderAwards();
            } catch (error) {
                console.error('Failed to load department data:', error);
                showStatus('Failed to load department data', 'error');
            }
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `rounded-lg p-4 border ${type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-green-500/20 border-green-500/50 text-green-200'}`;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }

        // Ensure we have exactly 5 Department Liaison slots
        function ensureDepartmentLiaisonSlots() {
            // Filter out department liaisons from subdivision leadership
            const liaisons = departmentData.subdivisionLeadership.filter(l => l.positionType === 'department_liaison');
            const others = departmentData.subdivisionLeadership.filter(l => l.positionType !== 'department_liaison');

            // Ensure we have exactly 5 slots
            while (liaisons.length < 5) {
                liaisons.push({
                    division: 'Department Liaison',
                    name: '',
                    callSign: '',
                    jobTitle: '',
                    discordId: '',
                    positionType: 'department_liaison'
                });
            }

            // Reconstruct subdivisionLeadership with liaisons first, then others
            departmentData.subdivisionLeadership = [...liaisons.slice(0, 5), ...others];
        }

        function renderDepartmentLiaisons() {
            const container = document.getElementById('departmentLiaisonsList');

            // Ensure we have 5 slots
            ensureDepartmentLiaisonSlots();

            // Get only department liaisons
            const liaisons = departmentData.subdivisionLeadership.filter(l => l.positionType === 'department_liaison');

            container.innerHTML = liaisons.map((liaison, index) => `
                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${liaison.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-full bg-rose-500/30 flex items-center justify-center text-rose-300 font-bold text-sm">
                            ${index + 1}
                        </div>
                        <span class="text-rose-300 font-medium">Liaison Slot ${index + 1}</span>
                        ${!liaison.name ? '<span class="text-white/40 text-sm">(Empty)</span>' : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
                            <input
                                type="text"
                                value="${liaison.name || ''}"
                                placeholder="Enter liaison name..."
                                class="liaison-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                            <input
                                type="text"
                                value="${liaison.jobTitle || ''}"
                                placeholder="Enter job title..."
                                class="liaison-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-rose-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Discord ID
                                <span class="text-xs text-white/50 font-normal ml-1">(enter ID to auto-populate name)</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <input
                                    type="text"
                                    value="${liaison.discordId || ''}"
                                    placeholder="Discord User ID..."
                                    class="liaison-discord-id flex-1 px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    data-index="${index}"
                                >
                                <button
                                    type="button"
                                    class="liaison-lookup-btn px-3 py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg transition-colors text-white text-sm font-medium flex items-center gap-1.5"
                                    data-index="${index}"
                                    title="Look up Discord user and auto-fill name"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </button>
                            </div>
                            <span class="liaison-lookup-status text-xs mt-1 hidden block" data-index="${index}"></span>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${liaison.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''}">
                                <input
                                    type="checkbox"
                                    class="liaison-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                    data-index="${index}"
                                    ${liaison.isLOA ? 'checked' : ''}
                                >
                                <span class="text-sm font-medium ${liaison.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');

            attachLiaisonListeners();
        }

        function attachLiaisonListeners() {
            // Get all department liaisons for updating
            const getLiaisonByIndex = (index) => {
                const liaisons = departmentData.subdivisionLeadership.filter(l => l.positionType === 'department_liaison');
                return liaisons[index];
            };

            document.querySelectorAll('.liaison-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const liaison = getLiaisonByIndex(index);
                    if (liaison) liaison.name = e.target.value;
                });
            });

            document.querySelectorAll('.liaison-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const liaison = getLiaisonByIndex(index);
                    if (liaison) liaison.jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.liaison-discord-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const liaison = getLiaisonByIndex(index);
                    if (liaison) liaison.discordId = e.target.value;
                });

                // Auto-lookup when user pastes or enters a valid Discord ID
                input.addEventListener('change', async (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const discordId = e.target.value.trim();

                    // Check if it looks like a valid Discord ID (17-20 digits)
                    if (/^\d{17,20}$/.test(discordId)) {
                        await lookupLiaisonDiscordUser(index, discordId, getLiaisonByIndex);
                    }
                });
            });

            // Lookup button click handlers for liaisons
            document.querySelectorAll('.liaison-lookup-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    const discordIdInput = document.querySelector(`.liaison-discord-id[data-index="${index}"]`);
                    const discordId = discordIdInput?.value?.trim();

                    if (discordId) {
                        await lookupLiaisonDiscordUser(index, discordId, getLiaisonByIndex);
                    } else {
                        showLiaisonLookupStatus(index, 'Enter a Discord ID first', 'warning');
                    }
                });
            });

            document.querySelectorAll('.liaison-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const liaison = getLiaisonByIndex(index);
                    if (liaison) liaison.isLOA = e.target.checked;
                    renderDepartmentLiaisons();
                });
            });
        }

        // Liaison-specific lookup helper functions
        function showLiaisonLookupStatus(index, message, type = 'info') {
            const statusEl = document.querySelector(`.liaison-lookup-status[data-index="${index}"]`);
            if (!statusEl) return;

            statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-yellow-400', 'text-blue-400');

            const colorClass = {
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'info': 'text-blue-400'
            }[type] || 'text-white/60';

            statusEl.classList.add(colorClass);
            statusEl.textContent = message;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        async function lookupLiaisonDiscordUser(index, discordId, getLiaisonByIndex) {
            const btn = document.querySelector(`.liaison-lookup-btn[data-index="${index}"]`);

            // Validate Discord ID format
            if (!/^\d{17,20}$/.test(discordId)) {
                showLiaisonLookupStatus(index, 'Invalid Discord ID format', 'error');
                return;
            }

            // Disable button and show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                `;
            }

            try {
                const response = await fetch(`/api/discord-user-lookup?userId=${encodeURIComponent(discordId)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success && result.user) {
                    // Auto-populate the name field
                    const nameInput = document.querySelector(`.liaison-name[data-index="${index}"]`);
                    const liaison = getLiaisonByIndex(index);
                    if (nameInput && liaison) {
                        nameInput.value = result.user.displayName;
                        liaison.name = result.user.displayName;
                    }

                    // Show success message
                    const memberStatus = result.isMember ? '' : ' (not in server)';
                    showLiaisonLookupStatus(index, `Found: ${result.user.displayName}${memberStatus}`, result.isMember ? 'success' : 'warning');
                } else {
                    showLiaisonLookupStatus(index, result.error || 'User not found', 'error');
                }
            } catch (error) {
                console.error('Discord lookup error:', error);
                showLiaisonLookupStatus(index, 'Lookup failed', 'error');
            } finally {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    `;
                }
            }
        }

        function renderCommandPositions() {
            const container = document.getElementById('commandList');

            if (!departmentData.commandPositions || departmentData.commandPositions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No command positions found.
                    </div>
                `;
                return;
            }

            container.innerHTML = departmentData.commandPositions.map((position, index) => `
                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${position.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Rank</label>
                            <div class="px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg text-teal-300 font-semibold">
                                ${position.rank}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Call Sign</label>
                            <input
                                type="text"
                                value="${position.callSign || ''}"
                                placeholder="e.g., 1R-01"
                                class="command-callsign w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-cyan-300 font-mono focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
                            <input
                                type="text"
                                value="${position.name || ''}"
                                placeholder="Enter officer name..."
                                class="command-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                            <input
                                type="text"
                                value="${position.jobTitle || ''}"
                                placeholder="Enter job title..."
                                class="command-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${position.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''}">
                                <input
                                    type="checkbox"
                                    class="command-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                    data-index="${index}"
                                    ${position.isLOA ? 'checked' : ''}
                                >
                                <span class="text-sm font-medium ${position.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-slate-300 mb-1">
                            Discord ID
                            <span class="text-xs text-white/50 font-normal ml-1">(for webhook mentions - not visible on site)</span>
                        </label>
                        <div class="flex gap-2 items-center">
                            <input
                                type="text"
                                value="${position.discordId || ''}"
                                placeholder="Enter Discord User ID (e.g., 123456789012345678)"
                                class="command-discord-id flex-1 md:w-1/2 px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                data-index="${index}"
                            >
                            <button
                                type="button"
                                class="command-lookup-btn flex items-center gap-2 px-4 py-2 bg-purple-600/50 hover:bg-purple-600/70 border border-purple-500 rounded-lg text-purple-200 transition-colors"
                                data-index="${index}"
                                title="Lookup Discord user to auto-fill callsign and name"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Lookup
                            </button>
                        </div>
                        <div class="command-lookup-status hidden mt-2 text-sm" data-index="${index}"></div>
                    </div>
                </div>
            `).join('');

            attachCommandListeners();
        }

        // Ranks that only show role mention in webhook (no individual member names)
        const roleOnlyRanks = [
            'Sergeant First Class', 'Staff Sergeant', 'Sergeant', 'Corporal',
            'Officer III', 'Officer II', 'Officer I', 'Probationary Officer',
            'Reserve Officer', 'Cadet'
        ];

        function renderRankPositions() {
            const container = document.getElementById('rankPositionsSections');

            if (!departmentData.rankPositions || departmentData.rankPositions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No rank positions found.
                    </div>
                `;
                return;
            }

            container.innerHTML = departmentData.rankPositions.map((rankPos, rankIndex) => {
                const colorInfo = rankColors[rankPos.rank] || { color: 'slate', tier: '' };
                const colorClass = colorInfo.color;
                const isRoleOnly = roleOnlyRanks.includes(rankPos.rank);

                // For role-only ranks (Cadet - Sergeant First Class), only show Discord Role ID
                if (isRoleOnly) {
                    return `
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold text-${colorClass}-400">${rankPos.rank}</h2>
                                <span class="text-sm text-white/60">${colorInfo.tier}</span>
                            </div>

                            <div class="p-4 bg-slate-800/30 rounded-lg border border-slate-600/30">
                                <label class="block text-sm font-medium text-purple-300 mb-2">
                                    Discord Role ID for ${rankPos.rank}
                                    <span class="text-xs text-white/50 font-normal ml-1">(pings this role in webhook like &lt;@&amp;roleId&gt;)</span>
                                </label>
                                <input
                                    type="text"
                                    value="${rankPos.discordRoleId || ''}"
                                    placeholder="Enter Discord Role ID (e.g., 123456789012345678)"
                                    class="rank-discord-role-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-purple-500/30 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    data-rank-index="${rankIndex}"
                                >
                                <p class="text-xs text-white/50 mt-1">Right-click on a role in Discord → Copy Role ID (requires Developer Mode enabled)</p>
                                <p class="text-xs text-green-400 mt-2">This rank displays only the role mention in the Chain of Command webhook (no individual names).</p>
                            </div>
                        </div>
                    `;
                }

                // For higher ranks (Master Sergeant and above), show full member details
                return `
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-${colorClass}-400">${rankPos.rank}</h2>
                            <span class="text-sm text-white/60">${colorInfo.tier}</span>
                        </div>

                        <div class="mb-6 p-4 bg-slate-800/30 rounded-lg border border-slate-600/30">
                            <label class="block text-sm font-medium text-purple-300 mb-2">
                                Discord Role ID for ${rankPos.rank}
                                <span class="text-xs text-white/50 font-normal ml-1">(pings this role in webhook like &lt;@&amp;roleId&gt;)</span>
                            </label>
                            <input
                                type="text"
                                value="${rankPos.discordRoleId || ''}"
                                placeholder="Enter Discord Role ID (e.g., 123456789012345678)"
                                class="rank-discord-role-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-purple-500/30 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                data-rank-index="${rankIndex}"
                            >
                            <p class="text-xs text-white/50 mt-1">Right-click on a role in Discord → Copy Role ID (requires Developer Mode enabled)</p>
                        </div>

                        <p class="text-white/60 mb-6">Add up to 6 members with this rank. Enter name, callsign, and job title.</p>

                        <div class="space-y-4">
                            ${rankPos.members.map((member, memberIndex) => `
                                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${member.isSuspended ? 'border-red-500/50 bg-red-500/10' : member.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Name #${memberIndex + 1}</label>
                                            <input
                                                type="text"
                                                value="${member.name || ''}"
                                                placeholder="Enter member name..."
                                                class="rank-member-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Callsign</label>
                                            <input
                                                type="text"
                                                value="${member.callSign || ''}"
                                                placeholder="Enter callsign..."
                                                class="rank-member-callsign w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white font-mono focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                                            <input
                                                type="text"
                                                value="${member.jobTitle || ''}"
                                                placeholder="Enter job title..."
                                                class="rank-member-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div class="flex items-end">
                                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${member.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''}">
                                                <input
                                                    type="checkbox"
                                                    class="rank-member-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                                    data-rank-index="${rankIndex}"
                                                    data-member-index="${memberIndex}"
                                                    ${member.isLOA ? 'checked' : ''}
                                                >
                                                <span class="text-sm font-medium ${member.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                                            </label>
                                        </div>
                                    </div>
                                    <!-- Status Row: Strikes, Activity, Suspension -->
                                    <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Strikes</label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="10"
                                                value="${member.strikes || 0}"
                                                placeholder="0"
                                                class="rank-member-strikes w-full px-4 py-2 bg-slate-700/50 border ${member.strikes > 0 ? 'border-orange-500' : 'border-slate-600'} rounded-lg ${member.strikes > 0 ? 'text-orange-300' : 'text-white'} focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Activity Status</label>
                                            <select
                                                class="rank-member-activity-status w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                                <option value="" ${!member.activityStatus || member.activityStatus === 'active' ? 'selected' : ''}>Active</option>
                                                <option value="warning" ${member.activityStatus === 'warning' ? 'selected' : ''}>Activity Warning</option>
                                                <option value="probation" ${member.activityStatus === 'probation' ? 'selected' : ''}>On Probation</option>
                                                <option value="inactive" ${member.activityStatus === 'inactive' ? 'selected' : ''}>Inactive</option>
                                            </select>
                                        </div>
                                        <div class="flex items-end">
                                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${member.isSuspended ? 'border-red-500 bg-red-500/20' : ''}">
                                                <input
                                                    type="checkbox"
                                                    class="rank-member-suspended w-4 h-4 rounded border-slate-500 text-red-500 focus:ring-red-500 focus:ring-offset-0"
                                                    data-rank-index="${rankIndex}"
                                                    data-member-index="${memberIndex}"
                                                    ${member.isSuspended ? 'checked' : ''}
                                                >
                                                <span class="text-sm font-medium ${member.isSuspended ? 'text-red-400' : 'text-slate-300'}">Suspended</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Suspension Reason</label>
                                            <input
                                                type="text"
                                                value="${member.suspensionReason || ''}"
                                                placeholder="Reason (if suspended)..."
                                                class="rank-member-suspension-reason w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-red-300 italic focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                                ${member.isSuspended ? '' : 'disabled'}
                                            >
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-slate-300 mb-1">
                                            Discord User ID
                                            <span class="text-xs text-white/50 font-normal ml-1">(optional - for individual mentions)</span>
                                        </label>
                                        <input
                                            type="text"
                                            value="${member.discordId || ''}"
                                            placeholder="Enter Discord User ID..."
                                            class="rank-member-discord-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            data-rank-index="${rankIndex}"
                                            data-member-index="${memberIndex}"
                                        >
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            attachRankListeners();
        }

        function renderSubdivisionLeadership() {
            const container = document.getElementById('subdivisionList');

            // Filter out Department Liaisons - they are managed in the dedicated Department Liaisons section
            const subdivisionLeadersOnly = departmentData.subdivisionLeadership
                .map((item, originalIndex) => ({ ...item, originalIndex }))
                .filter(item => item.positionType !== 'department_liaison');

            if (!subdivisionLeadersOnly || subdivisionLeadersOnly.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No subdivision leadership data found. Click "Add Subdivision" to create one.
                    </div>
                `;
                return;
            }

            // Helper function to get subdivision display name for a leader
            function getLinkedSubdivisionName(subdivisionId) {
                if (!subdivisionId) return null;
                const sub = availableSubdivisions.find(s => s.id === subdivisionId);
                return sub ? `${sub.abbreviation} - ${sub.name}` : null;
            }

            // Helper function to get position type display info
            function getPositionTypeInfo(positionType) {
                switch(positionType) {
                    case 'overseer': return { label: 'Head of Subdivisions', color: 'teal' };
                    case 'assistant_head': return { label: 'Assistant Head', color: 'purple' };
                    default: return { label: 'Subdivision Leader', color: 'orange' };
                }
            }

            container.innerHTML = subdivisionLeadersOnly.map((subdivision) => {
                const index = subdivision.originalIndex;
                const linkedName = getLinkedSubdivisionName(subdivision.subdivisionId);
                const posInfo = getPositionTypeInfo(subdivision.positionType);
                const isVacant = subdivision.isVacant || false;

                return `
                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${isVacant ? 'border-gray-500/50 bg-gray-500/10' : subdivision.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                    <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Division Name</label>
                            <input
                                type="text"
                                value="${subdivision.division || ''}"
                                placeholder="Enter division name..."
                                class="subdivision-division w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-orange-300 font-semibold focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
                            <input
                                type="text"
                                value="${isVacant ? 'Looking for Head of ' + (subdivision.division || 'Subdivision') : (subdivision.name || '')}"
                                placeholder="Enter head name..."
                                class="subdivision-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent ${isVacant ? 'bg-gray-600/50 text-gray-400' : ''}"
                                data-index="${index}"
                                ${isVacant ? 'readonly' : ''}
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Callsign</label>
                            <input
                                type="text"
                                value="${isVacant ? 'N/A' : (subdivision.callSign || '')}"
                                placeholder="Enter callsign..."
                                class="subdivision-callsign w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white font-mono focus:ring-2 focus:ring-orange-500 focus:border-transparent ${isVacant ? 'bg-gray-600/50 text-gray-400' : ''}"
                                data-index="${index}"
                                ${isVacant ? 'readonly' : ''}
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                            <input
                                type="text"
                                value="${subdivision.jobTitle || ''}"
                                placeholder="Enter job title..."
                                class="subdivision-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${isVacant ? 'border-gray-500 bg-gray-500/20' : ''}">
                                <input
                                    type="checkbox"
                                    class="subdivision-vacant w-4 h-4 rounded border-slate-500 text-gray-500 focus:ring-gray-500 focus:ring-offset-0"
                                    data-index="${index}"
                                    ${isVacant ? 'checked' : ''}
                                >
                                <span class="text-sm font-medium ${isVacant ? 'text-gray-400' : 'text-slate-300'}">Vacant</span>
                            </label>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${subdivision.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''} ${isVacant ? 'opacity-50 cursor-not-allowed' : ''}">
                                <input
                                    type="checkbox"
                                    class="subdivision-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                    data-index="${index}"
                                    ${subdivision.isLOA ? 'checked' : ''}
                                    ${isVacant ? 'disabled' : ''}
                                >
                                <span class="text-sm font-medium ${subdivision.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                            </label>
                        </div>
                        <div class="flex items-end">
                            <button
                                class="delete-subdivision-btn px-4 py-2 bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 rounded-lg text-red-400 transition-colors w-full"
                                data-index="${index}"
                            >
                                <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Position Type</label>
                            <select
                                class="subdivision-position-type w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-${posInfo.color}-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                                <option value="leader" ${!subdivision.positionType || subdivision.positionType === 'leader' ? 'selected' : ''}>Subdivision Leader</option>
                                <option value="assistant_head" ${subdivision.positionType === 'assistant_head' ? 'selected' : ''}>Assistant Head of Subdivisions</option>
                                <option value="overseer" ${subdivision.positionType === 'overseer' ? 'selected' : ''}>Head of Subdivisions (Overseer)</option>
                            </select>
                            <p class="text-xs text-${posInfo.color}-400 mt-1">Current: ${posInfo.label}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Link to Subdivision</label>
                            <select
                                class="subdivision-link w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                                <option value="">-- Select subdivision --</option>
                                ${availableSubdivisions.map(sub =>
                                    `<option value="${sub.id}" ${subdivision.subdivisionId === sub.id ? 'selected' : ''}>${sub.abbreviation} - ${sub.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Or Custom Subdivision ID</label>
                            <input
                                type="text"
                                value="${subdivision.subdivisionId && !availableSubdivisions.some(s => s.id === subdivision.subdivisionId) ? subdivision.subdivisionId : ''}"
                                placeholder="e.g., subdivision-overseer"
                                class="subdivision-custom-id w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-cyan-300 font-mono focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                            <p class="text-xs text-white/50 mt-1">Use "subdivision-overseer" for the Subdivision Overseer</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-slate-300 mb-1">
                            Discord ID
                            <span class="text-xs text-white/50 font-normal ml-1">(enter ID to auto-populate name)</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input
                                type="text"
                                value="${subdivision.discordId || ''}"
                                placeholder="Enter Discord User ID (e.g., 123456789012345678)"
                                class="subdivision-discord-id flex-1 md:max-w-[50%] px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                data-index="${index}"
                            >
                            <button
                                type="button"
                                class="subdivision-lookup-btn px-3 py-2 bg-purple-600 hover:bg-purple-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg transition-colors text-white text-sm font-medium flex items-center gap-1.5"
                                data-index="${index}"
                                title="Look up Discord user and auto-fill name"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Lookup
                            </button>
                            <span class="subdivision-lookup-status text-sm hidden" data-index="${index}"></span>
                        </div>
                    </div>
                    <div class="mt-2">
                        ${linkedName ? `<p class="text-xs text-green-400">Linked to: ${linkedName}</p>` :
                          (subdivision.subdivisionId ? `<p class="text-xs text-cyan-400">Custom ID: ${subdivision.subdivisionId}</p>` :
                          `<p class="text-xs text-yellow-400">Not linked - set a subdivision link or custom ID</p>`)}
                    </div>
                </div>
            `}).join('');

            attachSubdivisionListeners();
        }

        function renderAwards() {
            const container = document.getElementById('awardsList');

            if (!departmentData.awardRecipients || departmentData.awardRecipients.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No awards found.
                    </div>
                `;
                return;
            }

            // Group awards by type (medals vs calendar-based)
            const medals = departmentData.awardRecipients.slice(0, 6);
            const timeBasedAwards = departmentData.awardRecipients.slice(6);

            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-yellow-300 mb-3">Medals</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${medals.map((award, index) => `
                            <div class="flex items-center gap-4 p-4 bg-slate-800/50 rounded-lg border border-slate-600/50">
                                <svg class="w-8 h-8 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-white/90 mb-1">${award.awardName}</div>
                                    <input
                                        type="text"
                                        value="${award.recipientName || ''}"
                                        placeholder="Enter recipient name..."
                                        class="award-recipient w-full px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded text-white italic text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                        data-index="${index}"
                                    >
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-300 mb-3">Recognition Awards</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${timeBasedAwards.map((award, i) => {
                            const index = i + 6;
                            const isPhotoOfWeek = award.awardName === 'Photo of the Week';
                            return `
                            <div class="flex flex-col gap-4 p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${isPhotoOfWeek ? 'md:col-span-2' : ''}">
                                <div class="flex items-center gap-4">
                                    <svg class="w-8 h-8 text-blue-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        ${award.awardName === 'Photo of the Week'
                                            ? '<path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />'
                                            : '<path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />'}
                                    </svg>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/90 mb-1">${award.awardName}</div>
                                        <input
                                            type="text"
                                            value="${award.recipientName || ''}"
                                            placeholder="Enter recipient name..."
                                            class="award-recipient w-full px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded text-white italic text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            data-index="${index}"
                                        >
                                    </div>
                                </div>
                                ${isPhotoOfWeek ? `
                                <div class="flex flex-col gap-2">
                                    <label class="text-sm font-medium text-slate-300">Image URL</label>
                                    <input
                                        type="text"
                                        value="${award.imageUrl || ''}"
                                        placeholder="Enter image URL (e.g., https://imgur.com/...)"
                                        class="photo-week-image w-full px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        data-index="${index}"
                                    >
                                    <p class="text-xs text-white/50">Paste a direct link to the image (Discord, Imgur, etc.)</p>
                                    ${award.imageUrl ? `
                                    <div class="mt-2">
                                        <p class="text-xs text-white/60 mb-1">Preview:</p>
                                        <img src="${award.imageUrl}" alt="Photo of the Week Preview" class="max-w-xs rounded border border-slate-600" onerror="this.style.display='none'" />
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;

            attachAwardListeners();
        }

        function attachRankListeners() {
            document.querySelectorAll('.rank-discord-role-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    departmentData.rankPositions[rankIndex].discordRoleId = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].name = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-callsign').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].callSign = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].isLOA = e.target.checked;
                    renderRankPositions();
                });
            });

            document.querySelectorAll('.rank-member-discord-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].discordId = e.target.value;
                });
            });

            // New status field listeners
            document.querySelectorAll('.rank-member-strikes').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    const value = parseInt(e.target.value, 10);
                    departmentData.rankPositions[rankIndex].members[memberIndex].strikes = isNaN(value) ? 0 : value;
                    renderRankPositions();
                });
            });

            document.querySelectorAll('.rank-member-activity-status').forEach(select => {
                select.addEventListener('change', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].activityStatus = e.target.value || undefined;
                });
            });

            document.querySelectorAll('.rank-member-suspended').forEach(input => {
                input.addEventListener('change', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].isSuspended = e.target.checked;
                    renderRankPositions();
                });
            });

            document.querySelectorAll('.rank-member-suspension-reason').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].suspensionReason = e.target.value;
                });
            });
        }

        // Command position Discord lookup functions
        function showCommandLookupStatus(index, message, type = 'info') {
            const statusEl = document.querySelector(`.command-lookup-status[data-index="${index}"]`);
            if (!statusEl) return;

            statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-yellow-400', 'text-slate-400');

            let colorClass = 'text-slate-400';
            if (type === 'success') colorClass = 'text-green-400';
            else if (type === 'error') colorClass = 'text-red-400';
            else if (type === 'warning') colorClass = 'text-yellow-400';

            statusEl.classList.add(colorClass);
            statusEl.textContent = message;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        async function lookupCommandDiscordUser(index, discordId) {
            const btn = document.querySelector(`.command-lookup-btn[data-index="${index}"]`);
            const statusEl = document.querySelector(`.command-lookup-status[data-index="${index}"]`);

            // Validate Discord ID format
            if (!/^\d{17,20}$/.test(discordId)) {
                showCommandLookupStatus(index, 'Invalid Discord ID format', 'error');
                return;
            }

            // Disable button and show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Looking up...
                `;
            }

            try {
                const response = await fetch(`/api/discord-user-lookup?userId=${encodeURIComponent(discordId)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success && result.user) {
                    // Auto-populate the callsign and name fields
                    const callsignInput = document.querySelector(`.command-callsign[data-index="${index}"]`);
                    const nameInput = document.querySelector(`.command-name[data-index="${index}"]`);

                    if (result.user.callSign && callsignInput) {
                        callsignInput.value = result.user.callSign;
                        departmentData.commandPositions[index].callSign = result.user.callSign;
                    }

                    if (result.user.parsedName && nameInput) {
                        nameInput.value = result.user.parsedName;
                        departmentData.commandPositions[index].name = result.user.parsedName;
                    } else if (result.user.displayName && nameInput) {
                        // Fall back to displayName if parsedName is not available
                        nameInput.value = result.user.displayName;
                        departmentData.commandPositions[index].name = result.user.displayName;
                    }

                    // Build status message
                    let statusMessage = '';
                    if (result.user.callSign && result.user.parsedName) {
                        statusMessage = `Found: ${result.user.callSign} | ${result.user.parsedName}`;
                    } else if (result.user.displayName) {
                        statusMessage = `Found: ${result.user.displayName}`;
                        if (!result.user.callSign) {
                            statusMessage += ' (no callsign detected in nickname)';
                        }
                    }

                    if (result.warning) {
                        showCommandLookupStatus(index, `${statusMessage} - ${result.warning}`, 'warning');
                    } else {
                        showCommandLookupStatus(index, statusMessage, 'success');
                    }
                } else {
                    showCommandLookupStatus(index, result.error || 'User not found', 'error');
                }
            } catch (error) {
                console.error('Discord lookup error:', error);
                showCommandLookupStatus(index, 'Failed to lookup user', 'error');
            } finally {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Lookup
                    `;
                }
            }
        }

        function attachCommandListeners() {
            document.querySelectorAll('.command-callsign').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].callSign = e.target.value;
                });
            });

            document.querySelectorAll('.command-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].name = e.target.value;
                });
            });

            document.querySelectorAll('.command-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.command-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].isLOA = e.target.checked;
                    renderCommandPositions();
                });
            });

            document.querySelectorAll('.command-discord-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].discordId = e.target.value;
                });

                // Auto-lookup when user pastes or enters a valid Discord ID
                input.addEventListener('change', async (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const discordId = e.target.value.trim();

                    // Check if it looks like a valid Discord ID (17-20 digits)
                    if (/^\d{17,20}$/.test(discordId)) {
                        await lookupCommandDiscordUser(index, discordId);
                    }
                });
            });

            // Lookup button click handlers
            document.querySelectorAll('.command-lookup-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    const discordIdInput = document.querySelector(`.command-discord-id[data-index="${index}"]`);
                    const discordId = discordIdInput?.value?.trim();

                    if (discordId) {
                        await lookupCommandDiscordUser(index, discordId);
                    } else {
                        showCommandLookupStatus(index, 'Enter a Discord ID first', 'warning');
                    }
                });
            });
        }

        function attachAwardListeners() {
            document.querySelectorAll('.award-recipient').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.awardRecipients[index].recipientName = e.target.value;
                });
            });

            document.querySelectorAll('.photo-week-image').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.awardRecipients[index].imageUrl = e.target.value;
                });
            });
        }

        // Discord user lookup helper functions
        function showLookupStatus(index, message, type = 'info') {
            const statusEl = document.querySelector(`.subdivision-lookup-status[data-index="${index}"]`);
            if (!statusEl) return;

            statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-yellow-400', 'text-blue-400');

            const colorClass = {
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'info': 'text-blue-400'
            }[type] || 'text-white/60';

            statusEl.classList.add(colorClass);
            statusEl.textContent = message;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        async function lookupDiscordUser(index, discordId) {
            const btn = document.querySelector(`.subdivision-lookup-btn[data-index="${index}"]`);
            const statusEl = document.querySelector(`.subdivision-lookup-status[data-index="${index}"]`);

            // Validate Discord ID format
            if (!/^\d{17,20}$/.test(discordId)) {
                showLookupStatus(index, 'Invalid Discord ID format', 'error');
                return;
            }

            // Disable button and show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Looking up...
                `;
            }

            try {
                const response = await fetch(`/api/discord-user-lookup?userId=${encodeURIComponent(discordId)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success && result.user) {
                    // Auto-populate the callsign field if available
                    const callsignInput = document.querySelector(`.subdivision-callsign[data-index="${index}"]`);
                    if (callsignInput && result.user.callSign) {
                        callsignInput.value = result.user.callSign;
                        departmentData.subdivisionLeadership[index].callSign = result.user.callSign;
                    }

                    // Auto-populate the name field (use parsedName if available, otherwise displayName)
                    const nameInput = document.querySelector(`.subdivision-name[data-index="${index}"]`);
                    const nameValue = result.user.parsedName || result.user.displayName;
                    if (nameInput && nameValue) {
                        nameInput.value = nameValue;
                        departmentData.subdivisionLeadership[index].name = nameValue;
                    }

                    // Show success message with both callsign and name
                    const memberStatus = result.isMember ? '' : ' (not in server)';
                    const foundInfo = result.user.callSign
                        ? `${result.user.callSign} - ${result.user.parsedName || result.user.displayName}`
                        : result.user.displayName;
                    showLookupStatus(index, `Found: ${foundInfo}${memberStatus}`, result.isMember ? 'success' : 'warning');
                } else {
                    showLookupStatus(index, result.error || 'User not found', 'error');
                }
            } catch (error) {
                console.error('Discord lookup error:', error);
                showLookupStatus(index, 'Lookup failed', 'error');
            } finally {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Lookup
                    `;
                }
            }
        }

        function attachSubdivisionListeners() {
            document.querySelectorAll('.subdivision-division').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].division = e.target.value;

                    // If position is vacant, update the auto-filled name
                    if (departmentData.subdivisionLeadership[index].isVacant) {
                        departmentData.subdivisionLeadership[index].name = 'Looking for Head of ' + (e.target.value || 'Subdivision');
                        const nameInput = document.querySelector(`.subdivision-name[data-index="${index}"]`);
                        if (nameInput) nameInput.value = departmentData.subdivisionLeadership[index].name;
                    }
                });
            });

            document.querySelectorAll('.subdivision-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].name = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-callsign').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].callSign = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-position-type').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].positionType = e.target.value;
                    renderSubdivisionLeadership();
                });
            });

            document.querySelectorAll('.subdivision-discord-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].discordId = e.target.value;
                });

                // Auto-lookup when user pastes or enters a valid Discord ID
                input.addEventListener('change', async (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const discordId = e.target.value.trim();

                    // Check if it looks like a valid Discord ID (17-20 digits)
                    if (/^\d{17,20}$/.test(discordId)) {
                        await lookupDiscordUser(index, discordId);
                    }
                });
            });

            // Lookup button click handlers
            document.querySelectorAll('.subdivision-lookup-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    const discordIdInput = document.querySelector(`.subdivision-discord-id[data-index="${index}"]`);
                    const discordId = discordIdInput?.value?.trim();

                    if (discordId) {
                        await lookupDiscordUser(index, discordId);
                    } else {
                        showLookupStatus(index, 'Enter a Discord ID first', 'warning');
                    }
                });
            });

            document.querySelectorAll('.subdivision-link').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const value = e.target.value;
                    if (value) {
                        departmentData.subdivisionLeadership[index].subdivisionId = value;
                        // Clear custom ID input when selecting from dropdown
                        const customInput = document.querySelector(`.subdivision-custom-id[data-index="${index}"]`);
                        if (customInput) customInput.value = '';
                    } else {
                        departmentData.subdivisionLeadership[index].subdivisionId = undefined;
                    }
                    renderSubdivisionLeadership();
                });
            });

            document.querySelectorAll('.subdivision-custom-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const value = e.target.value.trim().toLowerCase().replace(/\s+/g, '-');
                    if (value) {
                        departmentData.subdivisionLeadership[index].subdivisionId = value;
                        // Clear dropdown when entering custom ID
                        const select = document.querySelector(`.subdivision-link[data-index="${index}"]`);
                        if (select) select.value = '';
                    }
                });
                input.addEventListener('blur', (e) => {
                    // Re-render on blur to update status display
                    renderSubdivisionLeadership();
                });
            });

            document.querySelectorAll('.delete-subdivision-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    if (confirm('Are you sure you want to delete this subdivision?')) {
                        departmentData.subdivisionLeadership.splice(index, 1);
                        renderSubdivisionLeadership();
                    }
                });
            });

            document.querySelectorAll('.subdivision-vacant').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const isVacant = e.target.checked;
                    departmentData.subdivisionLeadership[index].isVacant = isVacant;

                    if (isVacant) {
                        // Auto-fill name and callsign for vacant positions
                        const divisionName = departmentData.subdivisionLeadership[index].division || 'Subdivision';
                        departmentData.subdivisionLeadership[index].name = 'Looking for Head of ' + divisionName;
                        departmentData.subdivisionLeadership[index].callSign = 'N/A';
                        departmentData.subdivisionLeadership[index].isLOA = false;
                        departmentData.subdivisionLeadership[index].discordId = '';
                    } else {
                        // Clear the auto-filled values when unchecking vacant
                        departmentData.subdivisionLeadership[index].name = '';
                        departmentData.subdivisionLeadership[index].callSign = '';
                    }

                    renderSubdivisionLeadership();
                });
            });

            document.querySelectorAll('.subdivision-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].isLOA = e.target.checked;
                    renderSubdivisionLeadership();
                });
            });
        }

        // Save changes
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch('/api/department-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(departmentData)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Changes saved successfully!', 'success');
                } else {
                    showStatus(result.error || 'Failed to save changes', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save changes', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });

        // Add Subdivision button handler
        document.getElementById('addSubdivisionBtn').addEventListener('click', () => {
            departmentData.subdivisionLeadership.push({
                division: '',
                name: '',
                callSign: '',
                jobTitle: '',
                positionType: 'leader'
            });
            renderSubdivisionLeadership();
        });

        // Sync from Roster button handler
        document.getElementById('syncRosterBtn').addEventListener('click', async () => {
            const syncBtn = document.getElementById('syncRosterBtn');
            syncBtn.disabled = true;
            syncBtn.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Syncing...
            `;

            try {
                const response = await fetch('/api/sync-roster', {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    // Update command positions
                    if (result.data.commandPositions) {
                        result.data.commandPositions.forEach((imported) => {
                            const existing = departmentData.commandPositions.find(cp => cp.rank === imported.rank);
                            if (existing) {
                                // Only update if imported has data
                                if (imported.name) {
                                    existing.name = imported.name;
                                    existing.callSign = imported.callSign || existing.callSign;
                                    existing.isLOA = imported.isLOA || false;
                                    // Always sync jobTitle from roster
                                    existing.jobTitle = imported.jobTitle || '';
                                    // Sync new status fields - always update to allow clearing values
                                    existing.strikes = imported.strikes ?? 0;
                                    existing.activityStatus = imported.activityStatus || undefined;
                                    existing.isSuspended = imported.isSuspended ?? false;
                                    existing.suspensionReason = imported.isSuspended ? imported.suspensionReason : undefined;
                                }
                            }
                        });
                    }

                    // Update rank positions
                    if (result.data.rankPositions) {
                        result.data.rankPositions.forEach((imported) => {
                            const existing = departmentData.rankPositions.find(rp => rp.rank === imported.rank);
                            if (existing) {
                                // Update members that have data
                                imported.members.forEach((member, idx) => {
                                    if (member.name && existing.members[idx]) {
                                        existing.members[idx].name = member.name;
                                        existing.members[idx].callSign = member.callSign || '';
                                        existing.members[idx].isLOA = member.isLOA || false;
                                        // Always sync jobTitle from roster
                                        existing.members[idx].jobTitle = member.jobTitle || '';
                                        // Sync new status fields - always update to allow clearing values
                                        existing.members[idx].strikes = member.strikes ?? 0;
                                        existing.members[idx].activityStatus = member.activityStatus || undefined;
                                        existing.members[idx].isSuspended = member.isSuspended ?? false;
                                        existing.members[idx].suspensionReason = member.isSuspended ? member.suspensionReason : undefined;
                                    }
                                });
                            }
                        });
                    }

                    // Re-render all sections
                    renderCommandPositions();
                    renderRankPositions();

                    // Update sync timestamp for auto-sync timer
                    lastSyncTimestamp = new Date();
                    updateSyncTimers();

                    showStatus(`Synced ${result.data.totalActive} active members from roster. Click "Save Changes" to persist.`, 'success');
                } else {
                    showStatus(result.error || 'Failed to sync roster data', 'error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showStatus('Failed to sync roster data', 'error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Manual Sync
                `;
            }
        });

        // Initialize
        validateSessionAndPermissions().then(valid => {
            if (valid) {
                loadDepartmentData();
                // Start auto-sync after initial load
                startAutoSync();
            }
        });

        // Auto-sync functionality
        let autoSyncInterval = null;
        let lastSyncTimestamp = null;
        const SYNC_INTERVAL_MS = 60000; // 1 minute

        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function updateSyncTimers() {
            const lastSyncEl = document.getElementById('lastSyncTime');
            const nextSyncEl = document.getElementById('nextSyncTime');

            if (lastSyncTimestamp && lastSyncEl) {
                lastSyncEl.textContent = `Last sync: ${formatTime(lastSyncTimestamp)}`;
            }

            if (nextSyncEl && lastSyncTimestamp) {
                const nextSyncTime = new Date(lastSyncTimestamp.getTime() + SYNC_INTERVAL_MS);
                nextSyncEl.textContent = `Next: ${formatTime(nextSyncTime)}`;
            }
        }

        async function performAutoSync() {
            const statusEl = document.getElementById('autoSyncStatus');

            try {
                // Update status to syncing
                if (statusEl) {
                    statusEl.innerHTML = `
                        <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span class="text-yellow-400">Syncing...</span>
                    `;
                }

                const response = await fetch('/api/sync-roster', {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    // Update command positions
                    if (result.data.commandPositions) {
                        result.data.commandPositions.forEach((imported) => {
                            const existing = departmentData.commandPositions.find(cp => cp.rank === imported.rank);
                            if (existing) {
                                if (imported.name) {
                                    existing.name = imported.name;
                                    existing.callSign = imported.callSign || existing.callSign;
                                    existing.isLOA = imported.isLOA || false;
                                    // Always sync jobTitle from roster
                                    existing.jobTitle = imported.jobTitle || '';
                                    existing.strikes = imported.strikes ?? 0;
                                    existing.activityStatus = imported.activityStatus || undefined;
                                    existing.isSuspended = imported.isSuspended ?? false;
                                    existing.suspensionReason = imported.isSuspended ? imported.suspensionReason : undefined;
                                }
                            }
                        });
                    }

                    // Update rank positions
                    if (result.data.rankPositions) {
                        result.data.rankPositions.forEach((imported) => {
                            const existing = departmentData.rankPositions.find(rp => rp.rank === imported.rank);
                            if (existing) {
                                imported.members.forEach((member, idx) => {
                                    if (member.name && existing.members[idx]) {
                                        existing.members[idx].name = member.name;
                                        existing.members[idx].callSign = member.callSign || '';
                                        existing.members[idx].isLOA = member.isLOA || false;
                                        // Always sync jobTitle from roster
                                        existing.members[idx].jobTitle = member.jobTitle || '';
                                        existing.members[idx].strikes = member.strikes ?? 0;
                                        existing.members[idx].activityStatus = member.activityStatus || undefined;
                                        existing.members[idx].isSuspended = member.isSuspended ?? false;
                                        existing.members[idx].suspensionReason = member.isSuspended ? member.suspensionReason : undefined;
                                    }
                                });
                            }
                        });
                    }

                    // Auto-save after sync
                    const saveResponse = await fetch('/api/department-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(departmentData)
                    });

                    const saveResult = await saveResponse.json();

                    // Re-render all sections
                    renderCommandPositions();
                    renderRankPositions();

                    // Update last sync time
                    lastSyncTimestamp = new Date();
                    updateSyncTimers();

                    // Update status to success
                    if (statusEl) {
                        statusEl.innerHTML = `
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <span class="text-green-400">Active</span>
                        `;
                    }

                    console.log(`Auto-sync completed: ${result.data.totalActive} members synced and saved`);
                } else {
                    throw new Error(result.error || 'Sync failed');
                }
            } catch (error) {
                console.error('Auto-sync error:', error);
                // Update status to error
                if (statusEl) {
                    statusEl.innerHTML = `
                        <span class="w-2 h-2 bg-red-400 rounded-full"></span>
                        <span class="text-red-400">Error</span>
                    `;
                }
                // Still update timestamp for next attempt
                lastSyncTimestamp = new Date();
                updateSyncTimers();
            }
        }

        function startAutoSync() {
            // Perform initial sync
            performAutoSync();

            // Set up interval for subsequent syncs
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            autoSyncInterval = setInterval(performAutoSync, SYNC_INTERVAL_MS);

            // Update countdown timer every second
            setInterval(updateSyncTimers, 1000);

            console.log('Auto-sync started: syncing every 60 seconds');
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
        });
    </script>
</Layout>
