---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Image Host - Del Perro Police Department" description="Upload and host images with custom names and raw links">
    <div class="space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">Image Host</h1>
                <p class="text-white/70">Upload images and get shareable links</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
            <h2 class="text-xl font-bold mb-4">Upload Image</h2>

            <div class="space-y-4">
                <!-- Custom Name Input -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Custom Name (Optional)</label>
                    <input
                        type="text"
                        id="customName"
                        placeholder="my-cool-image"
                        class="w-full px-4 py-3 bg-slate-800/50 border border-white/10 rounded-xl text-white placeholder-white/40 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                    >
                    <p class="text-xs text-white/50 mt-1">Letters, numbers, hyphens, and underscores only. Leave blank for auto-generated name.</p>
                </div>

                <!-- Drop Zone -->
                <div
                    id="dropZone"
                    class="border-2 border-dashed border-white/30 rounded-xl p-8 text-center hover:border-primary hover:bg-white/5 transition-all cursor-pointer"
                >
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <svg class="w-12 h-12 mx-auto mb-4 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-white/70 mb-2">Drop an image here or click to select</p>
                    <p class="text-sm text-white/50">Supports: JPEG, PNG, GIF, WebP, SVG (Max 10MB)</p>
                </div>

                <!-- Preview -->
                <div id="preview" class="hidden">
                    <div class="flex items-center gap-4 p-4 bg-slate-800/50 rounded-xl">
                        <img id="previewImage" src="" alt="Preview" class="w-20 h-20 object-cover rounded-lg">
                        <div class="flex-grow">
                            <p id="fileName" class="font-medium text-white"></p>
                            <p id="fileSize" class="text-sm text-white/60"></p>
                        </div>
                        <button id="removeFile" class="p-2 text-red-400 hover:text-red-300 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Upload Button -->
                <button
                    id="uploadBtn"
                    disabled
                    class="w-full py-3 bg-primary hover:bg-primary/80 disabled:bg-slate-700 disabled:cursor-not-allowed rounded-xl transition-colors font-semibold"
                >
                    Upload Image
                </button>
            </div>
        </div>

        <!-- Upload Result -->
        <div id="uploadResult" class="hidden bg-green-500/20 border border-green-500/50 rounded-xl p-6">
            <h3 class="text-lg font-bold text-green-300 mb-4">Image Uploaded Successfully!</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-green-300/80 mb-1">View Link</label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="viewLink"
                            readonly
                            class="flex-grow px-4 py-2 bg-slate-800/50 border border-green-500/30 rounded-lg text-white font-mono text-sm"
                        >
                        <button class="copy-btn px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition-colors" data-target="viewLink">
                            Copy
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-green-300/80 mb-1">Raw Link (Direct Image URL)</label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="rawLink"
                            readonly
                            class="flex-grow px-4 py-2 bg-slate-800/50 border border-green-500/30 rounded-lg text-white font-mono text-sm"
                        >
                        <button class="copy-btn px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition-colors" data-target="rawLink">
                            Copy
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-green-300/80 mb-1">Raw Link (By Name)</label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="rawNameLink"
                            readonly
                            class="flex-grow px-4 py-2 bg-slate-800/50 border border-green-500/30 rounded-lg text-white font-mono text-sm"
                        >
                        <button class="copy-btn px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition-colors" data-target="rawNameLink">
                            Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-500/20 border border-red-500/50 rounded-xl p-4 text-red-300">
        </div>

        <!-- Uploaded Images Gallery -->
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
            <h2 class="text-xl font-bold mb-4">Uploaded Images</h2>
            <div id="imagesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div class="col-span-full text-center py-8 text-white/60">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                    <p>Loading images...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Detail Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div class="relative w-full max-w-3xl mx-auto my-8">
            <!-- Close Button -->
            <button id="closeModal" class="absolute -top-12 right-0 text-white/80 hover:text-white p-2 transition-colors z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Modal Content -->
            <div class="bg-slate-800 rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
                <!-- Image Preview -->
                <div class="relative bg-slate-900 flex items-center justify-center" style="min-height: 300px;">
                    <img id="modalImage" src="" alt="" class="max-w-full max-h-[60vh] object-contain">
                </div>

                <!-- Image Info -->
                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 id="modalName" class="text-xl font-bold text-white"></h3>
                        <button id="deleteImageBtn" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition-colors text-sm font-semibold">
                            Delete Image
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-white/60">Original Name:</span>
                            <span id="modalOriginalName" class="text-white ml-2"></span>
                        </div>
                        <div>
                            <span class="text-white/60">Size:</span>
                            <span id="modalSize" class="text-white ml-2"></span>
                        </div>
                        <div>
                            <span class="text-white/60">Type:</span>
                            <span id="modalType" class="text-white ml-2"></span>
                        </div>
                        <div>
                            <span class="text-white/60">Uploaded:</span>
                            <span id="modalDate" class="text-white ml-2"></span>
                        </div>
                    </div>

                    <div class="space-y-2 pt-4 border-t border-white/10">
                        <div>
                            <label class="block text-sm font-medium text-white/60 mb-1">Raw Link (By ID)</label>
                            <div class="flex gap-2">
                                <input type="text" id="modalRawLink" readonly class="flex-grow px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white font-mono text-sm">
                                <button class="copy-btn px-3 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors" data-target="modalRawLink">Copy</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-white/60 mb-1">Raw Link (By Name)</label>
                            <div class="flex gap-2">
                                <input type="text" id="modalNameLink" readonly class="flex-grow px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white font-mono text-sm">
                                <button class="copy-btn px-3 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors" data-target="modalNameLink">Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let selectedFile = null;
        let imagesData = [];
        let currentImageId = null;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFile = document.getElementById('removeFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const customNameInput = document.getElementById('customName');
        const uploadResult = document.getElementById('uploadResult');
        const errorMessage = document.getElementById('errorMessage');
        const imagesGrid = document.getElementById('imagesGrid');
        const modal = document.getElementById('imageModal');
        const closeModal = document.getElementById('closeModal');
        const deleteImageBtn = document.getElementById('deleteImageBtn');

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }

        function handleFile(file) {
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
            if (!allowedTypes.includes(file.type)) {
                showError('Invalid file type. Allowed: JPEG, PNG, GIF, WebP, SVG');
                return;
            }

            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('File too large. Maximum size is 10MB');
                return;
            }

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
            };
            reader.readAsDataURL(file);

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            preview.classList.remove('hidden');
            dropZone.classList.add('hidden');
            uploadBtn.disabled = false;
        }

        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            preview.classList.add('hidden');
            dropZone.classList.remove('hidden');
            uploadBtn.disabled = true;
            uploadResult.classList.add('hidden');
        }

        // Drop zone events
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-white/5');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-white/5');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-white/5');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file);
        });

        removeFile.addEventListener('click', clearFile);

        // Upload
        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            uploadResult.classList.add('hidden');
            errorMessage.classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const customName = customNameInput.value.trim();
                if (customName) {
                    formData.append('customName', customName);
                }

                const response = await fetch('/api/images', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const baseUrl = window.location.origin;

                    document.getElementById('viewLink').value = baseUrl + result.urls.view;
                    document.getElementById('rawLink').value = baseUrl + result.urls.raw;
                    document.getElementById('rawNameLink').value = baseUrl + result.urls.rawByName;

                    uploadResult.classList.remove('hidden');
                    clearFile();
                    customNameInput.value = '';
                    loadImages(); // Refresh the gallery
                } else {
                    showError(result.error || 'Failed to upload image');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showError('Failed to upload image. Please try again.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Image';
            }
        });

        // Copy buttons
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const input = document.getElementById(targetId);
                if (input) {
                    navigator.clipboard.writeText(input.value);
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = originalText, 1500);
                }
            });
        });

        // Load images
        async function loadImages() {
            try {
                const response = await fetch('/api/images');
                const data = await response.json();
                imagesData = data.images || [];
                renderImages();
            } catch (error) {
                console.error('Failed to load images:', error);
                imagesGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-red-400">
                        <p>Failed to load images. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function renderImages() {
            if (imagesData.length === 0) {
                imagesGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-white/60">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="text-lg">No images uploaded yet</p>
                        <p class="text-sm text-white/40 mt-1">Upload your first image above</p>
                    </div>
                `;
                return;
            }

            imagesGrid.innerHTML = imagesData.map(image => `
                <div class="image-card cursor-pointer group bg-slate-800/40 rounded-xl overflow-hidden border border-white/5 hover:border-primary/30 transition-all duration-300 hover:shadow-xl hover:shadow-primary/10 hover:-translate-y-1" data-image-id="${image.id}">
                    <div class="relative aspect-square bg-slate-900/50 overflow-hidden">
                        <img
                            src="/api/images/raw/${image.id}"
                            alt="${image.customName}"
                            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                            loading="lazy"
                            onerror="this.parentElement.innerHTML='<div class=\"flex items-center justify-center h-full text-white/20\"><svg class=\"w-12 h-12\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1\" d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"/></svg></div>'"
                        >
                    </div>
                    <div class="p-3 bg-gradient-to-b from-slate-800/80 to-slate-800/40">
                        <h3 class="font-medium text-white text-sm truncate">${image.customName}</h3>
                        <p class="text-xs text-white/50 mt-1">${formatFileSize(image.size)}</p>
                    </div>
                </div>
            `).join('');

            // Attach click events
            document.querySelectorAll('.image-card').forEach(card => {
                card.addEventListener('click', () => {
                    const imageId = card.dataset.imageId;
                    const image = imagesData.find(img => img.id === imageId);
                    if (image) {
                        openModal(image);
                    }
                });
            });
        }

        function openModal(image) {
            currentImageId = image.id;
            const baseUrl = window.location.origin;

            document.getElementById('modalImage').src = `/api/images/raw/${image.id}`;
            document.getElementById('modalName').textContent = image.customName;
            document.getElementById('modalOriginalName').textContent = image.originalName;
            document.getElementById('modalSize').textContent = formatFileSize(image.size);
            document.getElementById('modalType').textContent = image.mimeType;
            document.getElementById('modalDate').textContent = new Date(image.uploadedAt).toLocaleString();
            document.getElementById('modalRawLink').value = `${baseUrl}/api/images/raw/${image.id}`;
            document.getElementById('modalNameLink').value = `${baseUrl}/api/images/raw/name/${image.customName}`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModalHandler() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            currentImageId = null;
        }

        closeModal.addEventListener('click', closeModalHandler);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModalHandler();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModalHandler();
            }
        });

        // Delete image
        deleteImageBtn.addEventListener('click', async () => {
            if (!currentImageId) return;

            if (!confirm('Are you sure you want to delete this image? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/images', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentImageId })
                });

                const result = await response.json();

                if (result.success) {
                    closeModalHandler();
                    loadImages();
                } else {
                    showError(result.error || 'Failed to delete image');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showError('Failed to delete image. Please try again.');
            }
        });

        // Initial load
        loadImages();
    </script>
</Layout>
