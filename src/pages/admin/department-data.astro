---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin - Department Data Management">
    <div class="space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">Department Data</h1>
                <p class="text-white/70">Manage awards recipients and chain of command</p>
            </div>
            <div class="flex gap-4">
                <a href="/admin" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                    Back to Dashboard
                </a>
                <button id="saveBtn" class="px-4 py-2 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold">
                    Save Changes
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden rounded-lg p-4 border">
        </div>

        <!-- Chain of Command Section - High Command -->
        <div id="commandSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <h2 class="text-2xl font-bold mb-4 text-teal-400">Chain of Command - High Command</h2>
            <p class="text-white/60 mb-6">Assign names and job titles to high command positions.</p>

            <div id="commandList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading chain of command data...
                </div>
            </div>
        </div>

        <!-- Rank-Based Positions Sections -->
        <div id="rankPositionsSections" class="space-y-6">
            <div class="text-center py-8 text-white/60">
                Loading rank positions data...
            </div>
        </div>

        <!-- Subdivision Leadership Section -->
        <div id="subdivisionSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-orange-400">Subdivision Leadership</h2>
                    <p class="text-white/60">Assign heads to each subdivision. Enter name, callsign, and job title.</p>
                </div>
                <button id="addSubdivisionBtn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Subdivision
                </button>
            </div>

            <div id="subdivisionList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading subdivision data...
                </div>
            </div>
        </div>

        <!-- Awards Recipients Section -->
        <div id="awardsSection" class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">Recent Awards & Recognition</h2>
            <p class="text-white/60 mb-6">Assign recipient names to awards. Names will appear in italic on the About page.</p>

            <div id="awardsList" class="space-y-4">
                <div class="text-center py-8 text-white/60">
                    Loading awards data...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let adminUser = null;

        async function validateSessionAndPermissions() {
            try {
                const response = await fetch('/api/auth/session', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/admin/login';
                    return false;
                }

                adminUser = data.user;

                // Check if user has permission for department data
                if (!hasFullPermission() && !hasSubdivisionOnlyPermission()) {
                    document.body.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center bg-slate-900">
                            <div class="text-center p-8">
                                <h1 class="text-3xl font-bold text-red-400 mb-4">Access Denied</h1>
                                <p class="text-white/70 mb-4">You don't have permission to access this page.</p>
                                <a href="/admin" class="px-6 py-2 bg-primary hover:bg-primary/80 rounded-lg">Return to Dashboard</a>
                            </div>
                        </div>
                    `;
                    return false;
                }

                // Hide sections that subdivision overseer shouldn't see
                const isSubdivisionOnly = !hasFullPermission() && hasSubdivisionOnlyPermission();
                if (isSubdivisionOnly) {
                    // Hide chain of command, rank positions, and awards sections
                    const commandSection = document.getElementById('commandSection');
                    const rankSection = document.getElementById('rankPositionsSections');
                    const awardsSection = document.getElementById('awardsSection');

                    if (commandSection) commandSection.style.display = 'none';
                    if (rankSection) rankSection.style.display = 'none';
                    if (awardsSection) awardsSection.style.display = 'none';
                }

                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                window.location.href = '/admin/login';
                return false;
            }
        }

        // Check if user has permission for department data
        function hasFullPermission() {
            if (!adminUser) return false;
            if (adminUser.role === 'super_admin') return true;
            return adminUser.permissions && adminUser.permissions.includes('department-data');
        }

        function hasSubdivisionOnlyPermission() {
            if (!adminUser) return false;
            if (adminUser.role === 'subdivision_overseer') return true;
            return adminUser.permissions && adminUser.permissions.includes('department-data-subdivisions');
        }

        let departmentData = {
            awardRecipients: [],
            commandPositions: [],
            tierPositions: [],
            rankPositions: [],
            subdivisionLeadership: []
        };

        let availableSubdivisions = [];

        // Default rank positions structure
        const defaultRankPositions = [
            {
                rank: 'Major',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Captain',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: '1st Lieutenant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: '2nd Lieutenant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Master Sergeant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Sergeant First Class',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Staff Sergeant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Sergeant',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Corporal',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Officer III',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Officer II',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Officer I',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Probationary Officer',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Reserve Officer',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            },
            {
                rank: 'Cadet',
                members: Array(6).fill(null).map(() => ({ name: '', callSign: '', jobTitle: '' }))
            }
        ];

        // Default subdivision leadership structure
        const defaultSubdivisionLeadership = [
            { division: 'Subdivision Overseer', name: '', callSign: '', jobTitle: '' },
            { division: 'Field Training Division', name: '', callSign: '', jobTitle: '' },
            { division: 'Special Weapons and Tactics', name: '', callSign: '', jobTitle: '' },
            { division: 'Traffic Enforcement Unit', name: '', callSign: '', jobTitle: '' },
            { division: 'Criminal Investigations Unit', name: '', callSign: '', jobTitle: '' },
            { division: 'K9 Division', name: '', callSign: '', jobTitle: '' }
        ];

        // Rank colors for styling
        const rankColors = {
            'Major': { color: 'blue', tier: 'Low Command' },
            'Captain': { color: 'blue', tier: 'Low Command' },
            '1st Lieutenant': { color: 'blue', tier: 'Low Command' },
            '2nd Lieutenant': { color: 'blue', tier: 'Low Command' },
            'Master Sergeant': { color: 'indigo', tier: 'Trial Low Command' },
            'Sergeant First Class': { color: 'purple', tier: 'Supervisors' },
            'Staff Sergeant': { color: 'purple', tier: 'Supervisors' },
            'Sergeant': { color: 'purple', tier: 'Supervisors' },
            'Corporal': { color: 'violet', tier: 'Trial Supervisor' },
            'Officer III': { color: 'amber', tier: 'Officers' },
            'Officer II': { color: 'amber', tier: 'Officers' },
            'Officer I': { color: 'amber', tier: 'Officers' },
            'Probationary Officer': { color: 'amber', tier: 'Officers' },
            'Reserve Officer': { color: 'lime', tier: 'Reserves' },
            'Cadet': { color: 'green', tier: 'Cadets' }
        };

        // Load department data
        async function loadDepartmentData() {
            try {
                // Load subdivisions first
                const subResponse = await fetch('/api/subdivisions');
                const subData = await subResponse.json();
                availableSubdivisions = subData.subdivisions || [];

                const response = await fetch('/api/department-data');
                const data = await response.json();
                departmentData = data;

                // Ensure rankPositions exists with proper structure
                if (!departmentData.rankPositions || departmentData.rankPositions.length === 0) {
                    departmentData.rankPositions = defaultRankPositions;
                }

                // Ensure each rank position has 6 members
                departmentData.rankPositions = departmentData.rankPositions.map(rp => {
                    while (rp.members.length < 6) {
                        rp.members.push({ name: '', callSign: '', jobTitle: '' });
                    }
                    return rp;
                });

                // Ensure command positions have jobTitle field
                if (departmentData.commandPositions) {
                    departmentData.commandPositions = departmentData.commandPositions.map(cp => ({
                        ...cp,
                        jobTitle: cp.jobTitle || ''
                    }));
                }

                // Ensure subdivisionLeadership exists
                if (!departmentData.subdivisionLeadership || departmentData.subdivisionLeadership.length === 0) {
                    departmentData.subdivisionLeadership = defaultSubdivisionLeadership;
                }

                renderCommandPositions();
                renderRankPositions();
                renderSubdivisionLeadership();
                renderAwards();
            } catch (error) {
                console.error('Failed to load department data:', error);
                showStatus('Failed to load department data', 'error');
            }
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `rounded-lg p-4 border ${type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-green-500/20 border-green-500/50 text-green-200'}`;
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 5000);
        }

        function renderCommandPositions() {
            const container = document.getElementById('commandList');

            if (!departmentData.commandPositions || departmentData.commandPositions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No command positions found.
                    </div>
                `;
                return;
            }

            container.innerHTML = departmentData.commandPositions.map((position, index) => `
                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${position.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Rank</label>
                            <div class="px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg text-teal-300 font-semibold">
                                ${position.rank}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Call Sign</label>
                            <div class="px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg text-cyan-300 font-mono">
                                ${position.callSign}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
                            <input
                                type="text"
                                value="${position.name || ''}"
                                placeholder="Enter officer name..."
                                class="command-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                            <input
                                type="text"
                                value="${position.jobTitle || ''}"
                                placeholder="Enter job title..."
                                class="command-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${position.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''}">
                                <input
                                    type="checkbox"
                                    class="command-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                    data-index="${index}"
                                    ${position.isLOA ? 'checked' : ''}
                                >
                                <span class="text-sm font-medium ${position.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-slate-300 mb-1">
                            Discord ID
                            <span class="text-xs text-white/50 font-normal ml-1">(for webhook mentions - not visible on site)</span>
                        </label>
                        <input
                            type="text"
                            value="${position.discordId || ''}"
                            placeholder="Enter Discord User ID (e.g., 123456789012345678)"
                            class="command-discord-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            data-index="${index}"
                        >
                    </div>
                </div>
            `).join('');

            attachCommandListeners();
        }

        // Ranks that only show role mention in webhook (no individual member names)
        const roleOnlyRanks = [
            'Sergeant First Class', 'Staff Sergeant', 'Sergeant', 'Corporal',
            'Officer III', 'Officer II', 'Officer I', 'Probationary Officer',
            'Reserve Officer', 'Cadet'
        ];

        function renderRankPositions() {
            const container = document.getElementById('rankPositionsSections');

            if (!departmentData.rankPositions || departmentData.rankPositions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No rank positions found.
                    </div>
                `;
                return;
            }

            container.innerHTML = departmentData.rankPositions.map((rankPos, rankIndex) => {
                const colorInfo = rankColors[rankPos.rank] || { color: 'slate', tier: '' };
                const colorClass = colorInfo.color;
                const isRoleOnly = roleOnlyRanks.includes(rankPos.rank);

                // For role-only ranks (Cadet - Sergeant First Class), only show Discord Role ID
                if (isRoleOnly) {
                    return `
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold text-${colorClass}-400">${rankPos.rank}</h2>
                                <span class="text-sm text-white/60">${colorInfo.tier}</span>
                            </div>

                            <div class="p-4 bg-slate-800/30 rounded-lg border border-slate-600/30">
                                <label class="block text-sm font-medium text-purple-300 mb-2">
                                    Discord Role ID for ${rankPos.rank}
                                    <span class="text-xs text-white/50 font-normal ml-1">(pings this role in webhook like &lt;@&amp;roleId&gt;)</span>
                                </label>
                                <input
                                    type="text"
                                    value="${rankPos.discordRoleId || ''}"
                                    placeholder="Enter Discord Role ID (e.g., 123456789012345678)"
                                    class="rank-discord-role-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-purple-500/30 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    data-rank-index="${rankIndex}"
                                >
                                <p class="text-xs text-white/50 mt-1">Right-click on a role in Discord → Copy Role ID (requires Developer Mode enabled)</p>
                                <p class="text-xs text-green-400 mt-2">This rank displays only the role mention in the Chain of Command webhook (no individual names).</p>
                            </div>
                        </div>
                    `;
                }

                // For higher ranks (Master Sergeant and above), show full member details
                return `
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6 border border-white/20">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-${colorClass}-400">${rankPos.rank}</h2>
                            <span class="text-sm text-white/60">${colorInfo.tier}</span>
                        </div>

                        <div class="mb-6 p-4 bg-slate-800/30 rounded-lg border border-slate-600/30">
                            <label class="block text-sm font-medium text-purple-300 mb-2">
                                Discord Role ID for ${rankPos.rank}
                                <span class="text-xs text-white/50 font-normal ml-1">(pings this role in webhook like &lt;@&amp;roleId&gt;)</span>
                            </label>
                            <input
                                type="text"
                                value="${rankPos.discordRoleId || ''}"
                                placeholder="Enter Discord Role ID (e.g., 123456789012345678)"
                                class="rank-discord-role-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-purple-500/30 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                data-rank-index="${rankIndex}"
                            >
                            <p class="text-xs text-white/50 mt-1">Right-click on a role in Discord → Copy Role ID (requires Developer Mode enabled)</p>
                        </div>

                        <p class="text-white/60 mb-6">Add up to 6 members with this rank. Enter name, callsign, and job title.</p>

                        <div class="space-y-4">
                            ${rankPos.members.map((member, memberIndex) => `
                                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${member.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Name #${memberIndex + 1}</label>
                                            <input
                                                type="text"
                                                value="${member.name || ''}"
                                                placeholder="Enter member name..."
                                                class="rank-member-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Callsign</label>
                                            <input
                                                type="text"
                                                value="${member.callSign || ''}"
                                                placeholder="Enter callsign..."
                                                class="rank-member-callsign w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white font-mono focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                                            <input
                                                type="text"
                                                value="${member.jobTitle || ''}"
                                                placeholder="Enter job title..."
                                                class="rank-member-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-${colorClass}-500 focus:border-transparent"
                                                data-rank-index="${rankIndex}"
                                                data-member-index="${memberIndex}"
                                            >
                                        </div>
                                        <div class="flex items-end">
                                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${member.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''}">
                                                <input
                                                    type="checkbox"
                                                    class="rank-member-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                                    data-rank-index="${rankIndex}"
                                                    data-member-index="${memberIndex}"
                                                    ${member.isLOA ? 'checked' : ''}
                                                >
                                                <span class="text-sm font-medium ${member.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-slate-300 mb-1">
                                            Discord User ID
                                            <span class="text-xs text-white/50 font-normal ml-1">(optional - for individual mentions)</span>
                                        </label>
                                        <input
                                            type="text"
                                            value="${member.discordId || ''}"
                                            placeholder="Enter Discord User ID..."
                                            class="rank-member-discord-id w-full md:w-1/2 px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-purple-300 font-mono focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            data-rank-index="${rankIndex}"
                                            data-member-index="${memberIndex}"
                                        >
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            attachRankListeners();
        }

        function renderSubdivisionLeadership() {
            const container = document.getElementById('subdivisionList');

            if (!departmentData.subdivisionLeadership || departmentData.subdivisionLeadership.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No subdivision leadership data found. Click "Add Subdivision" to create one.
                    </div>
                `;
                return;
            }

            // Helper function to get subdivision display name for a leader
            function getLinkedSubdivisionName(subdivisionId) {
                if (!subdivisionId) return null;
                const sub = availableSubdivisions.find(s => s.id === subdivisionId);
                return sub ? `${sub.abbreviation} - ${sub.name}` : null;
            }

            container.innerHTML = departmentData.subdivisionLeadership.map((subdivision, index) => {
                const linkedName = getLinkedSubdivisionName(subdivision.subdivisionId);

                return `
                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${subdivision.isLOA ? 'border-yellow-500/50 bg-yellow-500/10' : ''}">
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Division Name</label>
                            <input
                                type="text"
                                value="${subdivision.division || ''}"
                                placeholder="Enter division name..."
                                class="subdivision-division w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-orange-300 font-semibold focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Name</label>
                            <input
                                type="text"
                                value="${subdivision.name || ''}"
                                placeholder="Enter head name..."
                                class="subdivision-name w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Callsign</label>
                            <input
                                type="text"
                                value="${subdivision.callSign || ''}"
                                placeholder="Enter callsign..."
                                class="subdivision-callsign w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white font-mono focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Job Title</label>
                            <input
                                type="text"
                                value="${subdivision.jobTitle || ''}"
                                placeholder="Enter job title..."
                                class="subdivision-job w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white italic focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center gap-2 px-4 py-2 bg-slate-700/30 border border-slate-600 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors w-full justify-center ${subdivision.isLOA ? 'border-yellow-500 bg-yellow-500/20' : ''}">
                                <input
                                    type="checkbox"
                                    class="subdivision-loa w-4 h-4 rounded border-slate-500 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0"
                                    data-index="${index}"
                                    ${subdivision.isLOA ? 'checked' : ''}
                                >
                                <span class="text-sm font-medium ${subdivision.isLOA ? 'text-yellow-400' : 'text-slate-300'}">LOA</span>
                            </label>
                        </div>
                        <div class="flex items-end">
                            <button
                                class="delete-subdivision-btn px-4 py-2 bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 rounded-lg text-red-400 transition-colors w-full"
                                data-index="${index}"
                            >
                                <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Link to Subdivision</label>
                            <select
                                class="subdivision-link w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                                <option value="">-- Select subdivision --</option>
                                ${availableSubdivisions.map(sub =>
                                    `<option value="${sub.id}" ${subdivision.subdivisionId === sub.id ? 'selected' : ''}>${sub.abbreviation} - ${sub.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Or Custom Subdivision ID</label>
                            <input
                                type="text"
                                value="${subdivision.subdivisionId && !availableSubdivisions.some(s => s.id === subdivision.subdivisionId) ? subdivision.subdivisionId : ''}"
                                placeholder="e.g., subdivision-overseer"
                                class="subdivision-custom-id w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-cyan-300 font-mono focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                data-index="${index}"
                            >
                            <p class="text-xs text-white/50 mt-1">Use "subdivision-overseer" for the Subdivision Overseer</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        ${linkedName ? `<p class="text-xs text-green-400">Linked to: ${linkedName}</p>` :
                          (subdivision.subdivisionId ? `<p class="text-xs text-cyan-400">Custom ID: ${subdivision.subdivisionId}</p>` :
                          `<p class="text-xs text-yellow-400">Not linked - set a subdivision link or custom ID</p>`)}
                    </div>
                </div>
            `}).join('');

            attachSubdivisionListeners();
        }

        function renderAwards() {
            const container = document.getElementById('awardsList');

            if (!departmentData.awardRecipients || departmentData.awardRecipients.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-white/60">
                        No awards found.
                    </div>
                `;
                return;
            }

            // Group awards by type (medals vs calendar-based)
            const medals = departmentData.awardRecipients.slice(0, 6);
            const timeBasedAwards = departmentData.awardRecipients.slice(6);

            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-yellow-300 mb-3">Medals</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${medals.map((award, index) => `
                            <div class="flex items-center gap-4 p-4 bg-slate-800/50 rounded-lg border border-slate-600/50">
                                <svg class="w-8 h-8 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-white/90 mb-1">${award.awardName}</div>
                                    <input
                                        type="text"
                                        value="${award.recipientName || ''}"
                                        placeholder="Enter recipient name..."
                                        class="award-recipient w-full px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded text-white italic text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                        data-index="${index}"
                                    >
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-300 mb-3">Recognition Awards</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${timeBasedAwards.map((award, i) => {
                            const index = i + 6;
                            const isPhotoOfWeek = award.awardName === 'Photo of the Week';
                            return `
                            <div class="flex flex-col gap-4 p-4 bg-slate-800/50 rounded-lg border border-slate-600/50 ${isPhotoOfWeek ? 'md:col-span-2' : ''}">
                                <div class="flex items-center gap-4">
                                    <svg class="w-8 h-8 text-blue-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        ${award.awardName === 'Photo of the Week'
                                            ? '<path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />'
                                            : '<path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />'}
                                    </svg>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/90 mb-1">${award.awardName}</div>
                                        <input
                                            type="text"
                                            value="${award.recipientName || ''}"
                                            placeholder="Enter recipient name..."
                                            class="award-recipient w-full px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded text-white italic text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            data-index="${index}"
                                        >
                                    </div>
                                </div>
                                ${isPhotoOfWeek ? `
                                <div class="flex flex-col gap-2">
                                    <label class="text-sm font-medium text-slate-300">Image URL</label>
                                    <input
                                        type="text"
                                        value="${award.imageUrl || ''}"
                                        placeholder="Enter image URL (e.g., https://imgur.com/...)"
                                        class="photo-week-image w-full px-3 py-1.5 bg-slate-700/50 border border-slate-600 rounded text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        data-index="${index}"
                                    >
                                    <p class="text-xs text-white/50">Paste a direct link to the image (Discord, Imgur, etc.)</p>
                                    ${award.imageUrl ? `
                                    <div class="mt-2">
                                        <p class="text-xs text-white/60 mb-1">Preview:</p>
                                        <img src="${award.imageUrl}" alt="Photo of the Week Preview" class="max-w-xs rounded border border-slate-600" onerror="this.style.display='none'" />
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;

            attachAwardListeners();
        }

        function attachRankListeners() {
            document.querySelectorAll('.rank-discord-role-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    departmentData.rankPositions[rankIndex].discordRoleId = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].name = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-callsign').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].callSign = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.rank-member-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].isLOA = e.target.checked;
                    renderRankPositions();
                });
            });

            document.querySelectorAll('.rank-member-discord-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const rankIndex = parseInt(e.target.dataset.rankIndex);
                    const memberIndex = parseInt(e.target.dataset.memberIndex);
                    departmentData.rankPositions[rankIndex].members[memberIndex].discordId = e.target.value;
                });
            });
        }

        function attachCommandListeners() {
            document.querySelectorAll('.command-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].name = e.target.value;
                });
            });

            document.querySelectorAll('.command-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.command-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].isLOA = e.target.checked;
                    renderCommandPositions();
                });
            });

            document.querySelectorAll('.command-discord-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.commandPositions[index].discordId = e.target.value;
                });
            });
        }

        function attachAwardListeners() {
            document.querySelectorAll('.award-recipient').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.awardRecipients[index].recipientName = e.target.value;
                });
            });

            document.querySelectorAll('.photo-week-image').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.awardRecipients[index].imageUrl = e.target.value;
                });
            });
        }

        function attachSubdivisionListeners() {
            document.querySelectorAll('.subdivision-division').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].division = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-name').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].name = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-callsign').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].callSign = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-job').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].jobTitle = e.target.value;
                });
            });

            document.querySelectorAll('.subdivision-link').forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const value = e.target.value;
                    if (value) {
                        departmentData.subdivisionLeadership[index].subdivisionId = value;
                        // Clear custom ID input when selecting from dropdown
                        const customInput = document.querySelector(`.subdivision-custom-id[data-index="${index}"]`);
                        if (customInput) customInput.value = '';
                    } else {
                        departmentData.subdivisionLeadership[index].subdivisionId = undefined;
                    }
                    renderSubdivisionLeadership();
                });
            });

            document.querySelectorAll('.subdivision-custom-id').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const value = e.target.value.trim().toLowerCase().replace(/\s+/g, '-');
                    if (value) {
                        departmentData.subdivisionLeadership[index].subdivisionId = value;
                        // Clear dropdown when entering custom ID
                        const select = document.querySelector(`.subdivision-link[data-index="${index}"]`);
                        if (select) select.value = '';
                    }
                });
                input.addEventListener('blur', (e) => {
                    // Re-render on blur to update status display
                    renderSubdivisionLeadership();
                });
            });

            document.querySelectorAll('.delete-subdivision-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    if (confirm('Are you sure you want to delete this subdivision?')) {
                        departmentData.subdivisionLeadership.splice(index, 1);
                        renderSubdivisionLeadership();
                    }
                });
            });

            document.querySelectorAll('.subdivision-loa').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    departmentData.subdivisionLeadership[index].isLOA = e.target.checked;
                    renderSubdivisionLeadership();
                });
            });
        }

        // Save changes
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await fetch('/api/department-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(departmentData)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Changes saved successfully!', 'success');
                } else {
                    showStatus(result.error || 'Failed to save changes', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save changes', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        });

        // Add Subdivision button handler
        document.getElementById('addSubdivisionBtn').addEventListener('click', () => {
            departmentData.subdivisionLeadership.push({
                division: '',
                name: '',
                callSign: '',
                jobTitle: ''
            });
            renderSubdivisionLeadership();
        });

        // Initialize
        validateSessionAndPermissions().then(valid => {
            if (valid) {
                loadDepartmentData();
            }
        });
    </script>
</Layout>
