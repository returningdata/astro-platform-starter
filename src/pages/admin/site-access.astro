---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="Site Access Management - Admin">
    <div class="py-8">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <a href="/admin" class="text-primary hover:text-primary/80 mb-4 inline-flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back to Admin
                </a>
                <h1 class="text-3xl font-bold mt-4">Site Access Management</h1>
                <p class="text-white/70 mt-2">Assign clearance levels to users by their Discord ID.</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="py-12 text-center">
                <div class="animate-spin w-12 h-12 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-white/70">Checking access...</p>
            </div>

            <!-- Unauthorized State -->
            <div id="unauthorizedState" class="hidden">
                <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-6 text-center">
                    <svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    <h2 class="text-xl font-bold text-red-400 mb-2">Access Denied</h2>
                    <p class="text-white/70">Only Super Admins can access this page.</p>
                    <a href="/admin" class="inline-block mt-4 px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                        Return to Admin
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" class="hidden">
                <div class="bg-slate-800/50 rounded-lg border border-slate-700 p-6">
                    <form id="accessForm" class="space-y-6">
                        <!-- Discord ID Input -->
                        <div>
                            <label for="discordId" class="block text-sm font-medium text-white/70 mb-2">
                                Discord User ID
                            </label>
                            <div class="flex gap-4">
                                <input
                                    type="text"
                                    id="discordId"
                                    placeholder="e.g., 123456789012345678"
                                    class="flex-1 px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary text-lg font-mono"
                                    required
                                />
                                <button
                                    type="button"
                                    id="lookupBtn"
                                    class="px-6 py-3 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors font-semibold"
                                >
                                    Lookup
                                </button>
                            </div>
                            <p class="text-xs text-white/50 mt-2">
                                Right-click a user's profile in Discord and select "Copy User ID" (Developer Mode must be enabled)
                            </p>
                        </div>

                        <!-- User Info Section (hidden until lookup) -->
                        <div id="userInfoSection" class="hidden">
                            <div class="border-t border-slate-700 pt-6">
                                <h3 class="text-lg font-semibold mb-4">User Information</h3>

                                <!-- User Card -->
                                <div id="userCard" class="bg-slate-700/30 rounded-lg p-4 mb-6">
                                    <div class="flex items-center gap-4">
                                        <img id="userPicture" src="" alt="Profile" class="w-16 h-16 rounded-full bg-slate-600" />
                                        <div class="flex-1">
                                            <h4 id="userName" class="font-bold text-lg"></h4>
                                            <p id="userOfficer" class="text-white/70 text-sm"></p>
                                            <p id="userDiscord" class="text-white/50 text-sm font-mono"></p>
                                        </div>
                                        <div class="text-right">
                                            <span id="currentClearanceBadge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                                            <p class="text-white/50 text-xs mt-1">Current</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Clearance Level Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-white/70 mb-3">
                                        Select New Clearance Level
                                    </label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="denied" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-red-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-red-500/20 text-red-300">DENIED</span>
                                                <p class="text-white/60 text-xs mt-2">Access revoked</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="pending" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-yellow-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-yellow-500/20 text-yellow-300">PENDING</span>
                                                <p class="text-white/60 text-xs mt-2">Awaiting approval</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="public_trust" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-green-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-green-500/20 text-green-300">PT</span>
                                                <p class="text-white/60 text-xs mt-2">Public Trust</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="confidential" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-cyan-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-cyan-500/20 text-cyan-300">C</span>
                                                <p class="text-white/60 text-xs mt-2">Confidential</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="secret" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-blue-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-blue-500/20 text-blue-300">S</span>
                                                <p class="text-white/60 text-xs mt-2">Secret</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="top_secret" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-orange-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-orange-500/20 text-orange-300">TS</span>
                                                <p class="text-white/60 text-xs mt-2">Top Secret</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="top_secret_sci" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-purple-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-purple-500/20 text-purple-300">TS/SCI</span>
                                                <p class="text-white/60 text-xs mt-2">Top Secret/SCI</p>
                                            </div>
                                        </label>
                                        <label class="clearance-option">
                                            <input type="radio" name="clearanceLevel" value="special_access" class="sr-only peer" />
                                            <div class="p-4 bg-slate-700/30 rounded-lg border-2 border-transparent peer-checked:border-pink-500 cursor-pointer hover:bg-slate-700/50 transition-colors">
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-pink-500/20 text-pink-300">SA</span>
                                                <p class="text-white/60 text-xs mt-2">Special Access</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="pt-6">
                                    <button
                                        type="submit"
                                        id="submitBtn"
                                        class="w-full px-6 py-3 bg-primary hover:bg-primary/80 rounded-lg transition-colors font-semibold text-lg"
                                    >
                                        Update Clearance Level
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Not Found Message -->
                        <div id="notFoundMessage" class="hidden">
                            <div class="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-4 text-center">
                                <svg class="w-8 h-8 text-yellow-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <p class="text-yellow-200">No user found with this Discord ID.</p>
                                <p class="text-white/50 text-sm mt-1">Make sure the user has logged into the Intel system at least once.</p>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Success Toast -->
                <div id="successToast" class="hidden fixed bottom-8 right-8 bg-green-500/20 border border-green-500/50 rounded-lg p-4 flex items-center gap-3">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="text-green-200">Clearance level updated successfully!</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const clearanceBadges = {
            pending: 'bg-yellow-500/20 text-yellow-300',
            public_trust: 'bg-green-500/20 text-green-300',
            confidential: 'bg-cyan-500/20 text-cyan-300',
            secret: 'bg-blue-500/20 text-blue-300',
            top_secret: 'bg-orange-500/20 text-orange-300',
            top_secret_sci: 'bg-purple-500/20 text-purple-300',
            special_access: 'bg-pink-500/20 text-pink-300',
            denied: 'bg-red-500/20 text-red-300',
        };

        const clearanceLabels = {
            pending: 'PENDING',
            public_trust: 'PT',
            confidential: 'C',
            secret: 'S',
            top_secret: 'TS',
            top_secret_sci: 'TS/SCI',
            special_access: 'SA',
            denied: 'DENIED',
        };

        let currentUser = null;

        // Check session
        async function checkSession() {
            try {
                const response = await fetch('/api/auth/session', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('loadingState').classList.add('hidden');

                if (!data.authenticated || data.user.role !== 'super_admin') {
                    document.getElementById('unauthorizedState').classList.remove('hidden');
                    return;
                }

                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Session error:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('unauthorizedState').classList.remove('hidden');
            }
        }

        // Lookup user
        document.getElementById('lookupBtn').addEventListener('click', async () => {
            const discordId = document.getElementById('discordId').value.trim();
            if (!discordId) {
                alert('Please enter a Discord ID');
                return;
            }

            const lookupBtn = document.getElementById('lookupBtn');
            lookupBtn.disabled = true;
            lookupBtn.textContent = 'Looking up...';

            try {
                const response = await fetch(`/api/admin/site-access?discordId=${encodeURIComponent(discordId)}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                document.getElementById('notFoundMessage').classList.add('hidden');
                document.getElementById('userInfoSection').classList.add('hidden');

                if (data.found && data.user) {
                    currentUser = data.user;

                    // Update user card
                    document.getElementById('userPicture').src = data.user.picture || '/default-avatar.png';
                    document.getElementById('userName').textContent = data.user.name || data.user.email;
                    document.getElementById('userOfficer').textContent = data.user.callsign && data.user.officerName
                        ? `${data.user.callsign} | ${data.user.officerName}`
                        : data.user.email;
                    document.getElementById('userDiscord').textContent = `Discord: ${data.user.discordUsername || 'N/A'} (${data.user.discordId})`;

                    // Update current clearance badge
                    const badge = document.getElementById('currentClearanceBadge');
                    badge.className = `px-3 py-1 rounded-full text-sm font-medium ${clearanceBadges[data.user.clearanceLevel] || clearanceBadges.pending}`;
                    badge.textContent = clearanceLabels[data.user.clearanceLevel] || data.user.clearanceLevel.toUpperCase();

                    // Pre-select current clearance level
                    const radio = document.querySelector(`input[name="clearanceLevel"][value="${data.user.clearanceLevel}"]`);
                    if (radio) {
                        radio.checked = true;
                    }

                    document.getElementById('userInfoSection').classList.remove('hidden');
                } else {
                    document.getElementById('notFoundMessage').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Lookup error:', error);
                alert('Error looking up user: ' + error.message);
            } finally {
                lookupBtn.disabled = false;
                lookupBtn.textContent = 'Lookup';
            }
        });

        // Submit form
        document.getElementById('accessForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert('Please lookup a user first');
                return;
            }

            const clearanceLevel = document.querySelector('input[name="clearanceLevel"]:checked')?.value;
            if (!clearanceLevel) {
                alert('Please select a clearance level');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            try {
                const response = await fetch('/api/admin/site-access', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        discordId: currentUser.discordId,
                        clearanceLevel
                    }),
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // Update the current clearance badge
                const badge = document.getElementById('currentClearanceBadge');
                badge.className = `px-3 py-1 rounded-full text-sm font-medium ${clearanceBadges[clearanceLevel] || clearanceBadges.pending}`;
                badge.textContent = clearanceLabels[clearanceLevel] || clearanceLevel.toUpperCase();

                // Show success toast
                const toast = document.getElementById('successToast');
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            } catch (error) {
                console.error('Update error:', error);
                alert('Error updating clearance: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Clearance Level';
            }
        });

        // Enter key triggers lookup
        document.getElementById('discordId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('lookupBtn').click();
            }
        });

        // Initialize
        checkSession();
    </script>
</Layout>
